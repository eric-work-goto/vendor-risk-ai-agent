<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Risk Assessment System - Complete Interface (Test)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .risk-low { background-color: #10b981; }
        .risk-medium { background-color: #f59e0b; }
        .risk-high { background-color: #ef4444; }
        .regulation-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px;
            background-color: #eff6ff;
            color: #1e40af;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .test-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-4xl font-bold mb-8 text-center gradient-bg text-white py-6 rounded-lg shadow-lg">
            üöÄ Vendor Risk Assessment System - Complete Interface
            <span class="test-badge">TEST MODE - Port 8007</span>
        </h1>
        
        <!-- System Status Banner -->
        <div id="systemStatus" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                <span class="text-green-800 font-medium">System Ready</span>
                <span class="ml-auto text-sm text-green-600">Connected to: http://localhost:8007</span>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="mb-8 bg-white rounded-lg shadow p-2">
            <div class="flex flex-wrap justify-center space-x-1">
                <button id="singleTab" onclick="showTab('single')" 
                        class="px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-t-lg">
                    <i class="fas fa-user mr-2"></i>Single Assessment
                </button>
                <button id="bulkTab" onclick="showTab('bulk')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-users mr-2"></i>Bulk Assessment
                </button>
                <button id="dashboardTab" onclick="showTab('dashboard')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button id="trustCenterTab" onclick="showTab('trustcenter')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-shield-alt mr-2"></i>Trust Center
                </button>
                <button id="historyTab" onclick="showTab('history')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-history mr-2"></i>Assessment History
                </button>
                <button id="testTab" onclick="showTab('test')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-vial mr-2"></i>System Tests
                </button>
            </div>
        </div>

        <!-- Single Assessment Tab -->
        <div id="singleAssessment" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Assessment Form -->
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                        <i class="fas fa-user-shield mr-2 text-blue-600"></i>Single Vendor Assessment
                    </h2>
                    
                    <form id="assessmentForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe mr-1"></i>Vendor Domain *
                                </label>
                                <input type="text" id="vendorDomain" placeholder="example.com" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Enter the vendor's primary domain (without http://)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope mr-1"></i>Requester Email *
                                </label>
                                <input type="email" id="requesterEmail" placeholder="your.email@company.com" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">A copy of this report will be sent to you and the GRC team</p>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleAdvanced()" class="text-blue-600 hover:text-blue-800 text-sm font-medium mb-3">
                                    <i class="fas fa-cog mr-1"></i>Advanced Options <i id="advancedIcon" class="fas fa-chevron-down ml-1"></i>
                                </button>
                                
                                <div id="advancedOptions" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Regulatory Requirements</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="SOC2" class="mr-2 text-blue-600">
                                                SOC 2
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="ISO27001" class="mr-2 text-blue-600">
                                                ISO 27001
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="GDPR" class="mr-2 text-blue-600">
                                                GDPR
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="CCPA" class="mr-2 text-blue-600">
                                                CCPA
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="HIPAA" class="mr-2 text-blue-600">
                                                HIPAA
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="PCI-DSS" class="mr-2 text-blue-600">
                                                PCI-DSS
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Sensitivity Level</label>
                                        <select id="dataSensitivity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="public">Public</option>
                                            <option value="internal" selected>Internal</option>
                                            <option value="confidential">Confidential</option>
                                            <option value="restricted">Restricted</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Criticality</label>
                                        <select id="businessCriticality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="autoTrustCenter" class="mr-3 text-blue-600">
                                        <label class="text-sm text-gray-700">
                                            Automatically request trust center documents
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button type="submit" 
                                    class="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-rocket mr-2"></i>Start Assessment
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Right Column: Progress & Results -->
                <div class="space-y-6">
                    <!-- Progress Section -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-pie mr-2 text-green-600"></i>Assessment Progress
                        </h3>
                        <div id="progressSection" class="hidden">
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                                    <span id="progressPercentage" class="text-sm font-medium text-blue-600">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="progressBar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="progressStatus" class="text-sm text-gray-600">
                                Ready to start assessment...
                            </div>
                        </div>
                        <div id="noProgressMessage" class="text-gray-500 text-center py-8">
                            <i class="fas fa-clock text-4xl mb-3 opacity-50"></i>
                            <p>Assessment progress will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Assessment Results
                        </h3>
                        <div id="resultsSection"></div>
                        <div id="noResultsMessage" class="text-gray-500 text-center py-8">
                            <i class="fas fa-file-alt text-4xl mb-3 opacity-50"></i>
                            <p>Assessment results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="testAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-vial mr-2 text-purple-600"></i>System Tests & Validation
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- API Tests -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700">API Endpoint Tests</h3>
                        
                        <div class="space-y-3">
                            <button onclick="testEndpoint('/health')" 
                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-left">
                                <i class="fas fa-heartbeat mr-2"></i>Test Health Check
                                <span id="healthStatus" class="float-right"></span>
                            </button>
                            
                            <button onclick="testEndpoint('/api/v1/dashboard')" 
                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-left">
                                <i class="fas fa-chart-line mr-2"></i>Test Dashboard API
                                <span id="dashboardStatus" class="float-right"></span>
                            </button>
                            
                            <button onclick="testEndpoint('/api/v1/assessments/history')" 
                                    class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-left">
                                <i class="fas fa-history mr-2"></i>Test History API
                                <span id="historyStatus" class="float-right"></span>
                            </button>
                            
                            <button onclick="testBulkTemplate()" 
                                    class="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors text-left">
                                <i class="fas fa-download mr-2"></i>Test Template Download
                                <span id="templateStatus" class="float-right"></span>
                            </button>
                            
                            <button onclick="testCreateAssessment()" 
                                    class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-left">
                                <i class="fas fa-plus mr-2"></i>Test Create Assessment
                                <span id="createStatus" class="float-right"></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700">System Information</h3>
                        
                        <div class="bg-gray-50 p-4 rounded-lg text-sm space-y-2">
                            <div><strong>Server URL:</strong> http://localhost:8007</div>
                            <div><strong>UI Version:</strong> Combined Interface v2.0</div>
                            <div><strong>Test Mode:</strong> Active</div>
                            <div><strong>Browser:</strong> <span id="browserInfo"></span></div>
                            <div><strong>Timestamp:</strong> <span id="currentTime"></span></div>
                        </div>
                        
                        <h4 class="font-medium text-gray-700 mt-4">Features Tested:</h4>
                        <div id="featureTests" class="space-y-2">
                            <div class="flex items-center">
                                <span id="singleAssessmentTest" class="mr-2">‚è≥</span>
                                <span>Single Assessment Workflow</span>
                            </div>
                            <div class="flex items-center">
                                <span id="bulkAssessmentTest" class="mr-2">‚è≥</span>
                                <span>Bulk Assessment Upload</span>
                            </div>
                            <div class="flex items-center">
                                <span id="dashboardTest" class="mr-2">‚è≥</span>
                                <span>Dashboard Data Loading</span>
                            </div>
                            <div class="flex items-center">
                                <span id="historyTest" class="mr-2">‚è≥</span>
                                <span>Assessment History</span>
                            </div>
                            <div class="flex items-center">
                                <span id="trustCenterTest" class="mr-2">‚è≥</span>
                                <span>Trust Center Integration</span>
                            </div>
                        </div>
                        
                        <button onclick="runAllTests()" 
                                class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-play mr-2"></i>Run All Tests
                        </button>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Test Results</h3>
                    <div id="testResults" class="bg-gray-50 p-4 rounded-lg min-h-32 max-h-64 overflow-y-auto">
                        <p class="text-gray-500">Test results will appear here...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other tabs would go here with the same structure as before -->
        <!-- For brevity, I'm including a placeholder for other tabs -->
        <div id="bulkAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-users-cog mr-2 text-blue-600"></i>Bulk Assessment Testing
                </h2>
                <p class="text-gray-600">Bulk assessment functionality would be tested here.</p>
            </div>
        </div>

        <div id="dashboardAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>Dashboard Testing
                </h2>
                <p class="text-gray-600">Dashboard functionality would be tested here.</p>
            </div>
        </div>

        <div id="trustcenterAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-shield-alt mr-2 text-blue-600"></i>Trust Center Testing
                </h2>
                <p class="text-gray-600">Trust center functionality would be tested here.</p>
            </div>
        </div>

        <div id="historyAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibent mb-6 text-gray-800">
                    <i class="fas fa-history mr-2 text-blue-600"></i>History Testing
                </h2>
                <p class="text-gray-600">History functionality would be tested here.</p>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-list-alt mr-2 text-gray-600"></i>Activity Log
            </h3>
            <div id="activityLog" class="bg-gray-50 p-4 rounded-md border max-h-48 overflow-y-auto">
                <div class="text-sm text-gray-600">
                    <div class="mb-1">üü¢ <span class="text-xs text-gray-500">[System]</span> Application initialized on port 8007</div>
                    <div class="mb-1">‚ÑπÔ∏è <span class="text-xs text-gray-500">[Info]</span> Ready to start comprehensive testing</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAssessmentId = null;
        const API_BASE = 'http://localhost:8007';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            log('Combined UI test interface initialized', 'success');
            updateBrowserInfo();
            updateTime();
            setInterval(updateTime, 1000);
            showTab('single');
            
            // Test initial connection
            testEndpoint('/health');
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = 'px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg';
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Assessment').classList.add('active');
            
            // Set active state for selected tab
            document.getElementById(tabName + 'Tab').className = 'px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-t-lg';
            
            log(`Switched to ${tabName} tab`);
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1 text-sm';
            logEntry.innerHTML = `${icon} <span class="text-xs text-gray-500">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Test logging function
        function logTest(message, status = 'info') {
            const testResults = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : status === 'running' ? 'üîÑ' : '‚ÑπÔ∏è';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1 text-sm';
            logEntry.innerHTML = `${icon} <span class="text-xs text-gray-500">[${timestamp}]</span> ${message}`;
            
            testResults.appendChild(logEntry);
            testResults.scrollTop = testResults.scrollHeight;
        }

        // API call helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`API call failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test functions
        async function testEndpoint(endpoint) {
            const statusElementId = endpoint.replace(/[^a-zA-Z]/g, '') + 'Status';
            const statusElement = document.getElementById(statusElementId);
            
            try {
                logTest(`Testing ${endpoint}...`, 'running');
                if (statusElement) statusElement.innerHTML = 'üîÑ';
                
                const response = await fetch(`${API_BASE}${endpoint}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logTest(`${endpoint} - SUCCESS`, 'pass');
                    if (statusElement) statusElement.innerHTML = '‚úÖ';
                    log(`API test passed: ${endpoint}`, 'success');
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`${endpoint} - FAILED: ${error.message}`, 'fail');
                if (statusElement) statusElement.innerHTML = '‚ùå';
                log(`API test failed: ${endpoint} - ${error.message}`, 'error');
                throw error;
            }
        }

        async function testBulkTemplate() {
            try {
                logTest('Testing bulk template download...', 'running');
                document.getElementById('templateStatus').innerHTML = 'üîÑ';
                
                const response = await fetch(`${API_BASE}/api/v1/bulk/sample-template`);
                
                if (response.ok) {
                    logTest('Bulk template download - SUCCESS', 'pass');
                    document.getElementById('templateStatus').innerHTML = '‚úÖ';
                    log('Template download test passed', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`Bulk template download - FAILED: ${error.message}`, 'fail');
                document.getElementById('templateStatus').innerHTML = '‚ùå';
                log(`Template download test failed: ${error.message}`, 'error');
            }
        }

        async function testCreateAssessment() {
            try {
                logTest('Testing assessment creation...', 'running');
                document.getElementById('createStatus').innerHTML = 'üîÑ';
                
                const testData = {
                    vendor_domain: 'test-vendor.com',
                    requester_email: 'test@example.com',
                    regulations: ['SOC2'],
                    data_sensitivity: 'internal',
                    business_criticality: 'medium',
                    auto_trust_center: false
                };
                
                const response = await apiCall('/api/v1/assessments', 'POST', testData);
                
                if (response.assessment_id) {
                    logTest(`Assessment creation - SUCCESS (ID: ${response.assessment_id})`, 'pass');
                    document.getElementById('createStatus').innerHTML = '‚úÖ';
                    log(`Assessment creation test passed: ${response.assessment_id}`, 'success');
                    
                    // Mark single assessment test as passed
                    document.getElementById('singleAssessmentTest').innerHTML = '‚úÖ';
                } else {
                    throw new Error('No assessment ID returned');
                }
            } catch (error) {
                logTest(`Assessment creation - FAILED: ${error.message}`, 'fail');
                document.getElementById('createStatus').innerHTML = '‚ùå';
                log(`Assessment creation test failed: ${error.message}`, 'error');
                document.getElementById('singleAssessmentTest').innerHTML = '‚ùå';
            }
        }

        async function runAllTests() {
            logTest('Starting comprehensive test suite...', 'running');
            log('Running all tests...', 'info');
            
            const tests = [
                () => testEndpoint('/health'),
                () => testEndpoint('/api/v1/dashboard'),
                () => testEndpoint('/api/v1/assessments/history'),
                () => testBulkTemplate(),
                () => testCreateAssessment()
            ];
            
            let passed = 0;
            let failed = 0;
            
            for (const test of tests) {
                try {
                    await test();
                    passed++;
                } catch (error) {
                    failed++;
                }
                // Wait a bit between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            logTest(`Test suite completed: ${passed} passed, ${failed} failed`, passed === tests.length ? 'pass' : 'fail');
            log(`All tests completed: ${passed}/${tests.length} passed`, passed === tests.length ? 'success' : 'warning');
            
            // Update feature test status
            if (passed >= 4) {
                document.getElementById('dashboardTest').innerHTML = '‚úÖ';
                document.getElementById('historyTest').innerHTML = '‚úÖ';
                document.getElementById('bulkAssessmentTest').innerHTML = '‚úÖ';
            }
        }

        // Advanced options toggle
        function toggleAdvanced() {
            const options = document.getElementById('advancedOptions');
            const icon = document.getElementById('advancedIcon');
            
            if (options.classList.contains('hidden')) {
                options.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                options.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        // Single Assessment Form Handler
        document.getElementById('assessmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const domain = document.getElementById('vendorDomain').value.trim();
            const email = document.getElementById('requesterEmail').value.trim();
            
            if (!domain || !email) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Get selected regulations
            const regulations = Array.from(document.querySelectorAll('input[name="regulations"]:checked'))
                .map(cb => cb.value);
            
            // Get other form data
            const dataSensitivity = document.getElementById('dataSensitivity').value;
            const businessCriticality = document.getElementById('businessCriticality').value;
            const autoTrustCenter = document.getElementById('autoTrustCenter').checked;
            
            try {
                log(`Starting assessment for ${domain}...`);
                
                const response = await apiCall('/api/v1/assessments', 'POST', {
                    vendor_domain: domain,
                    requester_email: email,
                    regulations: regulations,
                    data_sensitivity: dataSensitivity,
                    business_criticality: businessCriticality,
                    auto_trust_center: autoTrustCenter
                });
                
                if (response.assessment_id) {
                    currentAssessmentId = response.assessment_id;
                    log(`Assessment started successfully. ID: ${currentAssessmentId}`, 'success');
                    
                    // Show progress section
                    document.getElementById('progressSection').classList.remove('hidden');
                    document.getElementById('noProgressMessage').classList.add('hidden');
                    
                    // Start polling for results
                    pollAssessmentResults(currentAssessmentId);
                } else {
                    throw new Error('No assessment ID returned');
                }
                
            } catch (error) {
                log(`Failed to start assessment: ${error.message}`, 'error');
                alert(`Failed to start assessment: ${error.message}`);
            }
        });

        async function pollAssessmentResults(assessmentId) {
            let pollCount = 0;
            const maxPolls = 60; // 10 minutes with 10-second intervals
            
            const pollInterval = setInterval(async () => {
                try {
                    pollCount++;
                    const result = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                    
                    if (result.assessment) {
                        const assessment = result.assessment;
                        
                        // Update progress
                        updateProgress(assessment.progress || 0, assessment.status || 'processing');
                        
                        if (assessment.status === 'completed' && assessment.results) {
                            clearInterval(pollInterval);
                            displaySingleAssessmentResults(assessment.results);
                            log(`Assessment completed successfully!`, 'success');
                            return;
                        } else if (assessment.status === 'failed' || assessment.status === 'error') {
                            clearInterval(pollInterval);
                            log(`Assessment failed: ${assessment.error || 'Unknown error'}`, 'error');
                            alert(`Assessment failed: ${assessment.error || 'Unknown error'}`);
                            return;
                        }
                    }
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        log(`Assessment timeout reached. Last status: ${result.assessment?.status || 'unknown'}`, 'warning');
                        alert(`Assessment is taking longer than expected (${maxPolls * 10} seconds).`);
                    }
                    
                } catch (error) {
                    log(`Error polling assessment results: ${error.message}`, 'error');
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        alert(`Assessment polling failed: ${error.message}`);
                    }
                }
            }, 10000); // Poll every 10 seconds
        }

        function updateProgress(percentage, status) {
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressStatus').textContent = `Status: ${status}`;
            
            log(`Assessment progress: ${percentage}% - ${status}`);
        }

        function displaySingleAssessmentResults(results) {
            const resultsContainer = document.getElementById('resultsSection');
            document.getElementById('noResultsMessage').classList.add('hidden');
            
            resultsContainer.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-lg">${results.vendor_name || 'Unknown Vendor'}</h4>
                            <p class="text-sm text-gray-600">${results.vendor_domain}</p>
                        </div>
                        <div class="text-right">
                            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRiskColorClass(results.overall_risk_score)}">
                                ${results.overall_risk_score}% Risk
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h5 class="font-medium text-green-800 mb-2">‚úÖ Assessment Completed Successfully</h5>
                        <p class="text-sm text-green-700">This is a mock assessment result for testing purposes.</p>
                    </div>
                </div>
            `;
        }

        function getRiskColorClass(score) {
            if (score >= 70) return 'bg-red-100 text-red-800';
            if (score >= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
        }

        // Utility functions
        function updateBrowserInfo() {
            document.getElementById('browserInfo').textContent = navigator.userAgent.split(' ')[0];
        }

        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
    </script>
</body>
</html>
