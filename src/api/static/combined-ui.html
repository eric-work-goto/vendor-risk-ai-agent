<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Risk Assessment System - Complete Interface</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="/static/api-config.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .risk-low { background-color: #10b981; }
        .risk-medium { background-color: #f59e0b; }
        .risk-high { background-color: #ef4444; }
        .regulation-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px;
            background-color: #eff6ff;
            color: #1e40af;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-4xl font-bold mb-8 text-center gradient-bg text-white py-6 rounded-lg shadow-lg">
            <i class="fas fa-shield-alt mr-3"></i>Vendor Risk Assessment System - Complete Interface
        </h1>
        
        <!-- Tab Navigation -->
        <div class="mb-8 bg-white rounded-lg shadow p-2">
            <div class="flex flex-wrap justify-center space-x-1">
                <button id="singleTab" onclick="showTab('single')" 
                        class="px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-t-lg">
                    <i class="fas fa-user mr-2"></i>Single Assessment
                </button>
                <button id="bulkTab" onclick="showTab('bulk')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-users mr-2"></i>Bulk Assessment
                </button>
                <button id="dashboardTab" onclick="showTab('dashboard')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard & Reports
                </button>
                <button id="trustCenterTab" onclick="showTab('trustcenter')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-shield-alt mr-2"></i>Trust Center
                </button>
                <button id="historyTab" onclick="showTab('history')" 
                        class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg">
                    <i class="fas fa-history mr-2"></i>Assessment History
                </button>
            </div>
        </div>

        <!-- Single Assessment Tab -->
        <div id="singleAssessment" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Assessment Form -->
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                        <i class="fas fa-user-shield mr-2 text-blue-600"></i>Single Vendor Assessment
                    </h2>
                    
                    <form id="assessmentForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe mr-1"></i>Vendor Domain *
                                </label>
                                <input type="text" id="vendorDomain" placeholder="example.com" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Enter the vendor's primary domain (without http://)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope mr-1"></i>Requester Email *
                                </label>
                                <input type="email" id="requesterEmail" placeholder="your.email@company.com" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Used for trust center document requests</p>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="border-t pt-4">
                                <button type="button" onclick="toggleAdvanced()" class="text-blue-600 hover:text-blue-800 text-sm font-medium mb-3">
                                    <i class="fas fa-cog mr-1"></i>Advanced Options <i id="advancedIcon" class="fas fa-chevron-down ml-1"></i>
                                </button>
                                
                                <div id="advancedOptions" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Regulatory Requirements</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="SOC2" class="mr-2 text-blue-600">
                                                SOC 2
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="ISO27001" class="mr-2 text-blue-600">
                                                ISO 27001
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="GDPR" class="mr-2 text-blue-600">
                                                GDPR
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="CCPA" class="mr-2 text-blue-600">
                                                CCPA
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="HIPAA" class="mr-2 text-blue-600">
                                                HIPAA
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="regulations" value="PCI-DSS" class="mr-2 text-blue-600">
                                                PCI-DSS
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Sensitivity Level</label>
                                        <select id="dataSensitivity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="public">Public</option>
                                            <option value="internal" selected>Internal</option>
                                            <option value="confidential">Confidential</option>
                                            <option value="restricted">Restricted</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Criticality</label>
                                        <select id="businessCriticality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="autoTrustCenter" class="mr-3 text-blue-600" checked>
                                        <label class="text-sm text-gray-700">
                                            Automatically request trust center documents
                                        </label>
                                    </div>
                                    
                                    <!-- Assessment Mode Selection -->
                                    <div class="border-t pt-4 mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-3">
                                            <i class="fas fa-crosshairs mr-1"></i>Assessment Mode
                                        </label>
                                        <div class="space-y-3">
                                            <label class="flex items-start p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                                <input type="radio" name="assessmentMode" value="business_risk" class="mt-1 mr-3 text-blue-600" checked>
                                                <div>
                                                    <div class="font-medium text-gray-900">Business Risk Assessment</div>
                                                    <div class="text-xs text-gray-500 mt-1">Focus: Reputation, compliance, business impact. Ideal for procurement and vendor management decisions.</div>
                                                    <div class="text-xs text-blue-600 mt-1">✓ More lenient scoring ✓ Business-focused categories ✓ Faster results</div>
                                                </div>
                                            </label>
                                            <label class="flex items-start p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                                <input type="radio" name="assessmentMode" value="technical_due_diligence" class="mt-1 mr-3 text-blue-600">
                                                <div>
                                                    <div class="font-medium text-gray-900">Technical Due Diligence</div>
                                                    <div class="text-xs text-gray-500 mt-1">Focus: Infrastructure, security controls, technical vulnerabilities. Ideal for IT security and compliance teams.</div>
                                                    <div class="text-xs text-orange-600 mt-1">⚠ Stricter scoring ⚠ Technical-focused categories ⚠ Comprehensive analysis</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="enhancedAssessment" class="mr-3 text-blue-600" checked>
                                        <label class="text-sm text-gray-700">
                                            <span class="font-medium">Enhanced Assessment</span>
                                            <span class="text-xs text-gray-500 block">Uses industry frameworks: MITRE CTSA, CWRAF, CWSS, CVSS, Open FAIR</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button type="submit" 
                                    class="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-rocket mr-2"></i>Start Assessment
                            </button>
                            
                            <!-- New Scan Button -->
                            <button type="button" onclick="startNewAssessment()" 
                                    class="w-full px-6 py-3 mt-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md hover:shadow-lg">
                                <i class="fas fa-plus mr-2"></i>New Scan
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Right Column: Progress & Results -->
                <div class="space-y-6">
                    <!-- Progress Section -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-pie mr-2 text-green-600"></i>Assessment Progress
                        </h3>
                        <div id="progressSection" class="hidden">
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                                    <span id="progressPercentage" class="text-sm font-medium text-blue-600">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="progressBar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="progressStatus" class="text-sm text-gray-600">
                                Ready to start assessment...
                            </div>
                        </div>
                        <div id="noProgressMessage" class="text-gray-500 text-center py-8">
                            <i class="fas fa-clock text-4xl mb-3 opacity-50"></i>
                            <p>Assessment progress will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Download Section -->
                    <div id="downloadSection" class="bg-white p-6 rounded-lg shadow hidden">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-download mr-2 text-green-600"></i>Download Report
                        </h3>
                        <div class="text-center">
                            <p class="text-gray-600 mb-4">Your assessment is complete! Download the full report below.</p>
                            <button id="downloadButton" onclick="downloadCurrentReport()" 
                                    class="px-6 py-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md hover:shadow-lg">
                                <i class="fas fa-download mr-2"></i>Download Full Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Assessment Results
                        </h3>
                        <div id="resultsSection"></div>
                        <div id="noResultsMessage" class="text-gray-500 text-center py-8">
                            <i class="fas fa-file-alt text-4xl mb-3 opacity-50"></i>
                            <p>Assessment results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Assessment Tab -->
        <div id="bulkAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-users-cog mr-2 text-blue-600"></i>Bulk Vendor Assessment
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Upload Section -->
                    <div>
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 class="font-semibold text-blue-800 mb-2">
                                <i class="fas fa-upload mr-2"></i>Upload Vendor List
                            </h3>
                            <p class="text-sm text-blue-700 mb-3">Upload a CSV or Excel file with your vendor list. Required columns:</p>
                            <div class="text-xs text-blue-600 bg-white p-3 rounded border">
                                <strong>Required:</strong> vendor_domain, vendor_name<br>
                                <strong>Optional:</strong> regulations, data_sensitivity, business_criticality, auto_trust_center
                            </div>
                        </div>
                        
                        <form id="bulkUploadForm" enctype="multipart/form-data">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Vendor List File</label>
                                    <input type="file" id="vendorFile" accept=".csv,.xlsx,.xls" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Requester Email (for Trust Center Access)</label>
                                    <input type="email" id="bulkRequesterEmail" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div class="flex gap-3">
                                    <button type="button" onclick="uploadVendorList()" 
                                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-upload mr-2"></i>Upload Vendor List
                                    </button>
                                    <button type="button" onclick="downloadSampleTemplate()" 
                                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Download Template
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Status Section -->
                    <div>
                        <div id="uploadStatus" class="hidden mb-6">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-md">
                                <h4 class="font-semibold text-green-800 mb-2">Upload Successful!</h4>
                                <div id="uploadDetails" class="text-sm text-green-700"></div>
                            </div>
                        </div>
                        
                        <div id="bulkProgressSection" class="hidden">
                            <h4 class="font-semibold text-gray-800 mb-3">Bulk Assessment Progress</h4>
                            <div id="bulkProgressList" class="space-y-2"></div>
                            
                            <!-- Export Options -->
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg border">
                                <h5 class="font-semibold text-gray-800 mb-3">Export Results</h5>
                                <div class="flex gap-3">
                                    <button id="exportExcelBtn" onclick="exportBulkResults('excel')" 
                                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400" 
                                            disabled>
                                        <i class="fas fa-file-excel mr-2"></i>Export to Excel
                                    </button>
                                    <button id="exportCsvBtn" onclick="exportBulkResults('csv')" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-400" 
                                            disabled>
                                        <i class="fas fa-file-csv mr-2"></i>Export to CSV
                                    </button>
                                    <button id="exportPdfBtn" onclick="exportBulkResults('pdf')" 
                                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors disabled:bg-gray-400" 
                                            disabled>
                                        <i class="fas fa-file-pdf mr-2"></i>Export Summary PDF
                                    </button>
                                </div>
                                <p class="text-xs text-gray-600 mt-2">Export options will be enabled once assessments are completed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Assessment Configuration Section -->
            <div id="vendorListSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-list mr-2 text-blue-600"></i>Uploaded Vendors
                </h3>
                
                <!-- Enhanced Assessment Configuration -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-3">Assessment Configuration</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Mode</label>
                            <select id="bulkAssessmentMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Assessment Mode</option>
                                <option value="technical_due_diligence">Technical Due Diligence</option>
                                <option value="business_risk">Business Risk Assessment</option>
                            </select>
                            <p class="text-xs text-gray-600 mt-1">Choose assessment focus and methodology</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Sensitivity</label>
                            <select id="bulkDataSensitivity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Data Sensitivity</option>
                                <option value="public">Public</option>
                                <option value="internal">Internal</option>
                                <option value="confidential">Confidential</option>
                                <option value="restricted">Restricted</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Criticality</label>
                            <select id="bulkBusinessCriticality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Business Criticality</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Regulations Section -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Compliance Regulations</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkGdpr" value="gdpr" class="mr-2">
                                <span class="text-sm">GDPR</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkCcpa" value="ccpa" class="mr-2">
                                <span class="text-sm">CCPA</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkHipaa" value="hipaa" class="mr-2">
                                <span class="text-sm">HIPAA</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkSox" value="sox" class="mr-2">
                                <span class="text-sm">SOX</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkIso27001" value="iso27001" class="mr-2">
                                <span class="text-sm">ISO 27001</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkSoc2" value="soc2" class="mr-2">
                                <span class="text-sm">SOC 2</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkPciDss" value="pci_dss" class="mr-2">
                                <span class="text-sm">PCI DSS</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="bulkFedRamp" value="fedramp" class="mr-2">
                                <span class="text-sm">FedRAMP</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Trust Center Options -->
                    <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="bulkAutoTrustCenter" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Enable automatic Trust Center document access</span>
                        </label>
                        <p class="text-xs text-gray-600 mt-1">Automatically attempt to access vendor trust centers and download compliance documents</p>
                    </div>
                    
                    <div class="mt-6 flex gap-3">
                        <button onclick="startBulkAssessments()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-rocket mr-2"></i>Start All Assessments
                        </button>
                        <button onclick="validateBulkConfiguration()" 
                                class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                            <i class="fas fa-check mr-2"></i>Validate Configuration
                        </button>
                    </div>
                </div>
                
                <!-- Vendor List Display -->
                <div id="bulkVendorList" class="space-y-4">
                    <!-- Vendors will be populated here -->
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardAssessment" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Summary Cards -->
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-check text-3xl text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Assessments</p>
                            <p id="totalAssessments" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">High Risk Vendors</p>
                            <p id="highRiskVendors" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-3xl text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Pending Reviews</p>
                            <p id="pendingReviews" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow card-hover">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-chart-line text-3xl text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Avg Risk Score</p>
                            <p id="avgRiskScore" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Distribution Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-pie-chart mr-2"></i>Risk Distribution
                    </h3>
                    <div id="riskDistributionChart" class="h-64 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Loading chart...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>Assessment Activity (Last 30 Days)
                    </h3>
                    <div id="activityChart" class="h-64 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Loading chart...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-line mr-2"></i>Assessment Overview
                </h3>
                <div id="dashboardContent">
                    <p class="text-gray-500 text-center py-8">Dashboard data will be loaded here...</p>
                </div>
            </div>

            <!-- Reports & Analytics Section -->
            <div class="mt-8 bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-6 text-gray-800">
                    <i class="fas fa-file-chart-line mr-2 text-blue-600"></i>Reports & Analytics
                </h3>
                
                <!-- Report Generation Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Executive Summary Report -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-pie mr-2 text-green-600"></i>Executive Summary Report
                        </h4>
                        <p class="text-gray-600 mb-4">Comprehensive overview of vendor risk landscape with executive-level insights and recommendations.</p>
                        
                        <div class="space-y-3 mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="includeRiskDistribution" class="mr-2" checked>
                                <span class="text-sm">Risk Distribution Analysis</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeTrendAnalysis" class="mr-2" checked>
                                <span class="text-sm">Trend Analysis</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeRecommendations" class="mr-2" checked>
                                <span class="text-sm">Risk Mitigation Recommendations</span>
                            </label>
                        </div>
                        
                        <button onclick="generateExecutiveReport()" 
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-file-pdf mr-2"></i>Generate Executive Report
                        </button>
                    </div>

                    <!-- Detailed Vendor Report -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-file-alt mr-2 text-blue-600"></i>Detailed Vendor Report
                        </h4>
                        <p class="text-gray-600 mb-4">Detailed assessment report for specific vendors with technical findings and compliance status.</p>
                        
                        <div class="space-y-3 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Vendors</label>
                                <select id="vendorSelect" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" size="3">
                                    <option value="all">All Assessed Vendors</option>
                                    <!-- Vendor options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <label class="flex items-center">
                                <input type="checkbox" id="includeComplianceDetails" class="mr-2" checked>
                                <span class="text-sm">Compliance Details</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="includeTechnicalFindings" class="mr-2" checked>
                                <span class="text-sm">Technical Findings</span>
                            </label>
                        </div>
                        
                        <button onclick="generateDetailedReport()" 
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-file-download mr-2"></i>Generate Detailed Report
                        </button>
                    </div>
                </div>

                <!-- Compliance Reports Section -->
                <div class="border border-gray-200 rounded-lg p-6 mb-8">
                    <h4 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-shield-check mr-2 text-purple-600"></i>Compliance Reports
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <button onclick="generateComplianceReport('SOC2')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-certificate text-2xl text-blue-600 mb-2"></i>
                            <div class="text-sm font-medium">SOC 2 Compliance</div>
                            <div class="text-xs text-gray-500">Service Organization Control</div>
                        </button>
                        
                        <button onclick="generateComplianceReport('ISO27001')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-award text-2xl text-green-600 mb-2"></i>
                            <div class="text-sm font-medium">ISO 27001</div>
                            <div class="text-xs text-gray-500">Information Security</div>
                        </button>
                        
                        <button onclick="generateComplianceReport('GDPR')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-user-shield text-2xl text-yellow-600 mb-2"></i>
                            <div class="text-sm font-medium">GDPR</div>
                            <div class="text-xs text-gray-500">Data Protection</div>
                        </button>
                        
                        <button onclick="generateComplianceReport('PCI-DSS')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-credit-card text-2xl text-red-600 mb-2"></i>
                            <div class="text-sm font-medium">PCI DSS</div>
                            <div class="text-xs text-gray-500">Payment Security</div>
                        </button>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-download mr-2 text-indigo-600"></i>Data Export Options
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="exportData('csv')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-file-csv text-2xl text-green-600 mb-2"></i>
                            <div class="text-sm font-medium">Export to CSV</div>
                            <div class="text-xs text-gray-500">Spreadsheet format</div>
                        </button>
                        
                        <button onclick="exportData('json')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-file-code text-2xl text-blue-600 mb-2"></i>
                            <div class="text-sm font-medium">Export to JSON</div>
                            <div class="text-xs text-gray-500">API/integration format</div>
                        </button>
                        
                        <button onclick="exportData('pdf')" 
                                class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-center">
                            <i class="fas fa-file-pdf text-2xl text-red-600 mb-2"></i>
                            <div class="text-sm font-medium">Export to PDF</div>
                            <div class="text-xs text-gray-500">Document format</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trust Center Tab -->
        <div id="trustcenterAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-shield-alt mr-2 text-blue-600"></i>Trust Center Document Management
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Request Documents -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Request Documents</h3>
                        <form id="trustCenterForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Vendor Domain</label>
                                    <input type="text" id="trustVendorDomain" placeholder="example.com"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           onchange="onTrustCenterVendorChange()">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Requester Email</label>
                                    <input type="email" id="trustRequesterEmail" placeholder="your.email@company.com"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Document Types</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="trustDocTypes" value="SOC2" class="mr-2">
                                            SOC 2 Report
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="trustDocTypes" value="ISO27001" class="mr-2">
                                            ISO 27001 Certificate
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="trustDocTypes" value="PCI-DSS" class="mr-2">
                                            PCI-DSS Report
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="trustDocTypes" value="GDPR" class="mr-2">
                                            GDPR Compliance
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button type="button" onclick="requestTrustCenterDocuments()"
                                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-file-download mr-2"></i>Request Documents
                                    </button>
                                    
                                    <button type="button" onclick="downloadTrustCenterDocuments()" id="tcDirectDownloadBtn"
                                            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Download Available
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Request Status and Available Documents -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Request Status & Available Documents</h3>
                        
                        <!-- Available Documents Section -->
                        <div id="tcAvailableDocuments" class="mb-6" style="display: none;">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h5 class="font-medium text-green-800 mb-3">
                                    <i class="fas fa-file-shield mr-2"></i>Available Documents
                                </h5>
                                <div id="tcDocumentsList" class="space-y-2">
                                    <!-- Documents will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Check -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Check Request Status</label>
                            <div class="flex gap-2">
                                <input type="text" id="statusRequestId" placeholder="Enter Request ID"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" onclick="checkTrustCenterStatus()"
                                        class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-search mr-1"></i>Check
                                </button>
                            </div>
                        </div>
                        
                        <div id="trustCenterStatus">
                            <p class="text-gray-500 text-center py-8">No active requests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyAssessment" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-history mr-2 text-blue-600"></i>Assessment History
                </h2>
                
                <div class="mb-4 flex justify-between items-center">
                    <div class="flex gap-4">
                        <input type="text" id="searchHistory" placeholder="Search assessments..."
                               class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="filterRisk" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Risk Levels</option>
                            <option value="low">Low Risk</option>
                            <option value="medium">Medium Risk</option>
                            <option value="high">High Risk</option>
                        </select>
                    </div>
                    <button onclick="refreshHistory()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                
                <div id="assessmentHistory">
                    <p class="text-gray-500 text-center py-8">Loading assessment history...</p>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-list-alt mr-2 text-gray-600"></i>Activity Log
            </h3>
            <div id="activityLog" class="bg-gray-50 p-4 rounded-md border max-h-48 overflow-y-auto">
                <div class="text-sm text-gray-600">
                    <div class="mb-1"><i class="fas fa-circle text-green-500"></i> <span class="text-xs text-gray-500">[System]</span> Application initialized</div>
                    <div class="mb-1">â„¹ï¸ <span class="text-xs text-gray-500">[Info]</span> Ready to start assessments</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Advanced options toggle - define early to ensure availability
        function toggleAdvanced() {
            console.log('toggleAdvanced called'); // Debug log
            const options = document.getElementById('advancedOptions');
            const icon = document.getElementById('advancedIcon');
            
            if (!options || !icon) {
                console.error('Advanced options elements not found');
                return;
            }
            
            if (options.classList.contains('hidden')) {
                options.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                options.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        // Make function globally available immediately
        window.toggleAdvanced = toggleAdvanced;
        
        // Start new assessment function - define early to ensure availability
        async function startNewAssessment() {
            console.log('startNewAssessment called'); // Debug log
            const form = document.getElementById('assessmentForm');
            if (!form) {
                console.error('Assessment form not found');
                return;
            }
            
            console.log('Form submitted via startNewAssessment!'); // Debug log
            
            // Create and dispatch submit event
            const submitEvent = new Event('submit', {
                bubbles: true,
                cancelable: true
            });
            form.dispatchEvent(submitEvent);
        }
        
        // Make function globally available immediately
        window.startNewAssessment = startNewAssessment;

        // Global variables
        let currentAssessmentId = null;
        let bulkAssessmentIds = [];
        
        // Initialize dynamic API configuration
        const apiConfig = new APIConfig();
        console.log('🚀 Using dynamic API base URL:', apiConfig.getBaseUrl());

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = 'px-6 py-3 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent rounded-t-lg';
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Assessment').classList.add('active');
            
            // Set active state for selected tab
            document.getElementById(tabName + 'Tab').className = 'px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-t-lg';
            
            log(`Switched to ${tabName} tab`);
            
            // Load data for specific tabs
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'history') {
                loadAssessmentHistory();
            }
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1 text-sm';
            logEntry.innerHTML = `${icon} <span class="text-xs text-gray-500">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // API call helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(apiConfig.getApiUrl(endpoint), options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`API call failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Single Assessment Functions
        document.getElementById('assessmentForm').addEventListener('submit', async function(e) {
            console.log('Form submitted!'); // Debug log
            e.preventDefault();
            
            const domain = document.getElementById('vendorDomain').value.trim();
            const email = document.getElementById('requesterEmail').value.trim();
            
            console.log('Domain:', domain, 'Email:', email); // Debug log
            
            if (!domain || !email) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Get selected regulations
            const regulations = Array.from(document.querySelectorAll('input[name="regulations"]:checked'))
                .map(cb => cb.value);
            
            // Get other form data
            const dataSensitivity = document.getElementById('dataSensitivity').value;
            const businessCriticality = document.getElementById('businessCriticality').value;
            const autoTrustCenter = document.getElementById('autoTrustCenter').checked;
            const enhancedAssessment = document.getElementById('enhancedAssessment').checked;
            
            // Get assessment mode
            const assessmentMode = document.querySelector('input[name="assessmentMode"]:checked').value;
            
            try {
                log(`Starting ${enhancedAssessment ? 'enhanced' : 'standard'} ${assessmentMode.replace('_', ' ')} assessment for ${domain}...`);
                
                const response = await apiCall('/api/v1/assessments', 'POST', {
                    vendor_domain: domain,
                    requester_email: email,
                    regulations: regulations,
                    data_sensitivity: dataSensitivity,
                    business_criticality: businessCriticality,
                    auto_trust_center: autoTrustCenter,
                    enhanced_assessment: enhancedAssessment,
                    assessment_mode: assessmentMode
                });
                
                if (response.assessment_id) {
                    currentAssessmentId = response.assessment_id;
                    log(`Assessment started successfully. ID: ${currentAssessmentId}`, 'success');
                    
                    // Show progress section
                    document.getElementById('progressSection').classList.remove('hidden');
                    document.getElementById('noProgressMessage').classList.add('hidden');
                    
                    // Start polling for results
                    pollAssessmentResults(currentAssessmentId);
                } else {
                    throw new Error('No assessment ID returned');
                }
                
            } catch (error) {
                log(`Failed to start assessment: ${error.message}`, 'error');
                alert(`Failed to start assessment: ${error.message}`);
            }
        });

        async function pollAssessmentResults(assessmentId) {
            let pollCount = 0;
            const maxPolls = 200; // 10 minutes with 3-second intervals (200 * 3 = 600 seconds = 10 minutes)
            
            log(`🔄 Starting polling for assessment ${assessmentId}`, 'info');
            
            const pollInterval = setInterval(async () => {
                try {
                    pollCount++;
                    log(`📡 Poll attempt ${pollCount}/${maxPolls} for assessment ${assessmentId}`, 'info');
                    
                    const result = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                    
                    if (result.assessment) {
                        const assessment = result.assessment;
                        
                        // Update progress
                        updateProgress(assessment.progress || 0, assessment.status || 'processing');
                        
                        log(`📊 Assessment status: ${assessment.status}, progress: ${assessment.progress}%`, 'info');
                        
                        if (assessment.status === 'completed' && assessment.results) {
                            clearInterval(pollInterval);
                            log(`✅ Assessment completed! Displaying results...`, 'success');
                            console.log('🔍 Full assessment object:', assessment);
                            console.log('📊 Assessment results data:', assessment.results);
                            console.log('🎯 About to call displaySingleAssessmentResults...');
                            console.log('🛡️ Current isDisplayingResults guard:', isDisplayingResults);
                            
                            // Check if results section exists before calling display function
                            const resultsElement = document.getElementById('resultsSection');
                            console.log('📋 Results section element:', resultsElement);
                            
                            await displaySingleAssessmentResults(assessment.results);
                            log(`Assessment completed successfully!`, 'success');
                            
                            // Refresh assessment history to show the completed assessment
                            setTimeout(() => {
                                loadAssessmentHistory();
                            }, 1000);
                            
                            return;
                        } else if (assessment.status === 'completed' && !assessment.results) {
                            log(`⚠️ Assessment marked completed but no results found!`, 'warning');
                            console.log('Assessment data (no results):', assessment);
                        } else if (assessment.status === 'failed' || assessment.status === 'error') {
                            clearInterval(pollInterval);
                            log(`Assessment failed: ${assessment.error || 'Unknown error'}`, 'error');
                            alert(`Assessment failed: ${assessment.error || 'Unknown error'}`);
                            return;
                        }
                    } else {
                        log(`⚠️ No assessment data in response`, 'warning');
                        console.log('Full response:', result);
                    }
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        log(`Assessment timeout reached. Last status: ${result.assessment?.status || 'unknown'}`, 'warning');
                        
                        // Try one more direct check
                        try {
                            const finalCheck = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                            if (finalCheck.assessment?.status === 'completed') {
                                log(`✅ Assessment completed on final check!`, 'success');
                                await displaySingleAssessmentResults(finalCheck.assessment.results);
                                
                                // Refresh assessment history to show the completed assessment
                                setTimeout(() => {
                                    loadAssessmentHistory();
                                }, 1000);
                                
                                return;
                            }
                        } catch (e) {
                            log(`Error on final check: ${e.message}`, 'error');
                        }
                        
                        alert(`Assessment is taking longer than expected (${maxPolls * 10} seconds).\n\nLast known status: ${result.assessment?.status || 'unknown'}\nProgress: ${result.assessment?.progress || 0}%\n\nThe assessment may still be running. You can try refreshing the page or checking the server logs.`);
                    }
                    
                } catch (error) {
                    log(`Error polling assessment results: ${error.message}`, 'error');
                    console.error('Polling error details:', error);
                    // Continue polling unless it's a critical error or we've hit max polls
                    if (pollCount >= maxPolls || error.message.includes('404') || error.message.includes('500')) {
                        clearInterval(pollInterval);
                        alert(`Assessment polling failed: ${error.message}\n\nPlease check the server status and try again.`);
                    }
                }
            }, 3000); // Poll every 3 seconds for faster response
        }

        function updateProgress(percentage, status) {
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressStatus').textContent = `Status: ${formatStatus(status)}`;
            
            log(`Assessment progress: ${percentage}% - ${status}`);
        }

        // Test function to directly test results display
        window.testResultsDisplay = function() {
            console.log('🧪 Testing results display directly...');
            
            // Mock assessment results
            const mockResults = {
                results: {
                    vendor_name: 'Test Vendor',
                    vendor_domain: 'testvendor.com',
                    overall_score: 85,
                    risk_level: 'low',
                    letter_grades: {
                        overall: 'B',
                        compliance: 'A',
                        security: 'B',
                        data_protection: 'B'
                    },
                    scores: {
                        compliance: 90,
                        security: 85,
                        data_protection: 80
                    },
                    risk_factors: [
                        {
                            category: 'security',
                            status: 'compliant',
                            description: 'Test security finding'
                        }
                    ],
                    recommendations: ['Test recommendation']
                }
            };
            
            console.log('🎯 Calling displaySingleAssessmentResults with mock data...');
            displaySingleAssessmentResults(mockResults);
        };

        // Guard to prevent multiple simultaneous executions
        let isDisplayingResults = false;

        async function displaySingleAssessmentResults(results) {
            // Prevent multiple simultaneous executions
            if (isDisplayingResults) {
                console.warn('⚠️ displaySingleAssessmentResults already running, skipping...');
                return;
            }
            
            isDisplayingResults = true;
            
            try {
                console.log('🎯 displaySingleAssessmentResults called with:', results);
                log('📋 Displaying assessment results...', 'info');
                
                // First, ensure we're on the right tab
                const singleAssessmentTab = document.getElementById('singleAssessment');
                if (singleAssessmentTab && !singleAssessmentTab.classList.contains('active')) {
                    console.log('🔄 Switching to Single Assessment tab...');
                    showTab('single');
                }
                
                const resultsContainer = document.getElementById('resultsSection');
                if (!resultsContainer) {
                    console.error('❌ Results container not found!');
                    log('Error: Results container (resultsSection) not found!', 'error');
                    // Try to find it with a more specific query
                    const allElements = document.querySelectorAll('[id*="result"]');
                    console.log('🔍 All elements with "result" in ID:', allElements);
                    return;
                }
                
                console.log('✅ Results container found:', resultsContainer);
                console.log('📐 Container dimensions:', {
                    width: resultsContainer.offsetWidth,
                    height: resultsContainer.offsetHeight,
                    display: window.getComputedStyle(resultsContainer).display,
                    visibility: window.getComputedStyle(resultsContainer).visibility
                });
                
                // Show the results section and hide the no results message
                resultsContainer.classList.remove('hidden');
                console.log('🎯 After removing hidden class - resultsContainer classes:', resultsContainer.className);
                console.log('🎯 resultsContainer visibility after unhiding:', window.getComputedStyle(resultsContainer).display);
                
                const noResultsMsg = document.getElementById('noResultsMessage');
                if (noResultsMsg) {
                    noResultsMsg.classList.add('hidden');
                    console.log('✅ Hidden no results message - noResultsMsg classes:', noResultsMsg.className);
                } else {
                    console.warn('⚠️ No results message element not found');
                }
                
                // Extract results data - could be nested in results.results
                const resultData = results.results || results;
                console.log('📊 Result data:', resultData);
                
                const overallScore = resultData.overall_score || resultData.overall_risk_score || 0;
                const recommendations = resultData.recommendations || [];
                const riskFactors = resultData.risk_factors || resultData.findings || [];
                
                console.log(`📈 Overall Score: ${overallScore}, Risk Factors: ${riskFactors.length}, Recommendations: ${recommendations.length}`);
                
                // Get selected regulatory requirements for compliance documentation
                const selectedRegulations = Array.from(document.querySelectorAll('input[name="regulations"]:checked'))
                    .map(cb => cb.value);
                
                console.log('📋 Selected regulations:', selectedRegulations);

                console.log('Building results HTML...');
                
                // Check if we have user-friendly scoring
                const hasLetterGrades = resultData.letter_grades || false;
                
                resultsContainer.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0">
                                <img id="vendorLogo" 
                                     src="${getVendorLogoUrl(resultData.vendor_domain || results.vendor_domain)}" 
                                     alt="${resultData.vendor_name || results.vendor_name || 'Vendor'} logo" 
                                     class="w-16 h-16 rounded-lg object-contain bg-white border border-gray-200 shadow-sm"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHJ4PSI4IiBmaWxsPSIjRjNGNEY2Ii8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIyOCIgcj0iOCIgZmlsbD0iIzlDQTNBRiIvPgogIDxyZWN0IHg9IjIwIiB5PSI0MCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjQiIHJ4PSIyIiBmaWxsPSIjOUNBM0FGIi8+CiAgPHJlY3QgeD0iMTYiIHk9IjQ4IiB3aWR0aD0iMzIiIGhlaWdodD0iNCIgcng9IjIiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'; this.onerror=null;">
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg">${resultData.vendor_name || results.vendor_name || 'Unknown Vendor'}</h4>
                                <p class="text-sm text-gray-600">${resultData.vendor_domain || results.vendor_domain || 'Unknown Domain'}</p>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${resultData.assessment_type ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${resultData.assessment_type === 'enhanced' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${resultData.assessment_type === 'enhanced' ? '🔬 Enhanced Assessment' : '📊 Standard Assessment'}</span>` : ''}
                                    ${resultData.assessment_mode ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${resultData.assessment_mode === 'technical_due_diligence' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}">${resultData.assessment_mode === 'technical_due_diligence' ? '🔧 Technical Due Diligence' : '💼 Business Risk'}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            ${hasLetterGrades ? `
                                <div class="inline-flex items-center px-4 py-2 rounded-full text-lg font-bold ${getLetterGradeColorClass(resultData.letter_grades.overall)}">
                                    ${resultData.letter_grades.overall}
                                </div>
                                <div class="text-sm font-medium text-gray-700 mt-1">${overallScore}/100</div>
                                <p class="text-sm text-gray-600 mt-1">${resultData.risk_description || 'Risk Assessment'}</p>
                                <p class="text-xs text-gray-500">${resultData.business_recommendation || ''}</p>
                            ` : `
                                <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRiskColorClass(overallScore)}">
                                    ${overallScore}% Risk
                                </div>
                            `}
                        </div>
                    </div>
                    
                    ${resultData.frameworks_used ? `
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h5 class="font-medium text-purple-800 mb-2">🏛️ Assessment Frameworks Used</h5>
                            <div class="flex flex-wrap gap-2">
                                ${resultData.frameworks_used.map(framework => `
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-700">
                                        ${framework}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${resultData.pillar_scores ? `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            ${Object.entries(resultData.pillar_scores).map(([pillar, score]) => `
                                <div class="p-4 bg-white border rounded-lg text-center">
                                    <h5 class="font-medium text-gray-700 mb-2">${pillar.charAt(0).toUpperCase() + pillar.slice(1)}</h5>
                                    <div class="text-2xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'} mb-1">
                                        ${Math.round(score)}
                                    </div>
                                    <div class="text-sm text-gray-600">${Math.round(score)}/100</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${hasLetterGrades ? `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-white border rounded-lg text-center">
                                <h5 class="font-medium text-gray-700 mb-2">Compliance</h5>
                                <div class="text-2xl font-bold ${getLetterGradeColorClass(resultData.letter_grades.compliance)} mb-1">
                                    ${resultData.letter_grades.compliance}
                                </div>
                                <div class="text-sm text-gray-600">${resultData.scores.compliance || 0}/100</div>
                            </div>
                            <div class="p-4 bg-white border rounded-lg text-center">
                                <h5 class="font-medium text-gray-700 mb-2">Security</h5>
                                <div class="text-2xl font-bold ${getLetterGradeColorClass(resultData.letter_grades.security)} mb-1">
                                    ${resultData.letter_grades.security}
                                </div>
                                <div class="text-sm text-gray-600">${resultData.scores.security || 0}/100</div>
                            </div>
                            <div class="p-4 bg-white border rounded-lg text-center">
                                <h5 class="font-medium text-gray-700 mb-2">Data Protection</h5>
                                <div class="text-2xl font-bold ${getLetterGradeColorClass(resultData.letter_grades.data_protection)} mb-1">
                                    ${resultData.letter_grades.data_protection}
                                </div>
                                <div class="text-sm text-gray-600">${resultData.scores.data_protection || 0}/100</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Business Risk Assessment Results -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Business Risk Assessment Results</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${riskFactors.length > 0 ? riskFactors.map((factor, index) => `
                                <div class="p-3 border rounded-lg">
                                    <div class="cursor-pointer" onclick="toggleRiskFactorDropdown('risk-factor-${index}')">
                                        <div class="flex items-center justify-between">
                                            <h5 class="font-medium text-sm text-gray-800">${getCapitalizedCategory(factor.category || 'Unknown Category')}</h5>
                                            <i class="fas fa-chevron-down text-gray-400" id="risk-factor-${index}-icon"></i>
                                        </div>
                                        <div class="mt-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${factor.status === 'compliant' ? 'bg-green-100 text-green-800' : factor.status === 'needs_review' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                                Status: ${formatStatus(factor.status)}
                                            </span>
                                        </div>
                                    </div>
                                    <div id="risk-factor-${index}" class="hidden mt-3 pt-3 border-t">
                                        <p class="text-xs text-gray-600">${factor.description || factor.item || 'No description available'}</p>
                                        ${getRiskFactorDetails(factor.category)}
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500">No detailed risk factors available</p>'}
                        </div>
                    </div>
                    
                    <!-- Data Breach History -->
                    ${resultData.data_breaches ? renderDataBreachSection(resultData.data_breaches) : ''}
                    
                    <!-- AI Features Available -->
                    ${renderAIFeaturesSection(resultData.ai_features || resultData.real_data_sources?.ai_scan || {})}
                    
                    <!-- AI Data Flow Documentation Discovery -->
                    ${renderDataPrivacyFlowSection(resultData.data_flows || resultData.real_data_sources?.data_flow_scan || {})}
                    
                    ${resultData.trust_center_access ? renderTrustCenterInfo(resultData.trust_center_access) : ''}
                </div>
            `;
            
            console.log('📝 Setting results HTML...');
            console.log('🔤 HTML content length:', resultsContainer.innerHTML.length);
            
            console.log('✅ Results HTML set successfully!');
            console.log('📋 Final container content:', resultsContainer.innerHTML.substring(0, 200) + '...');
            console.log('🎯 Final container visibility:', {
                display: window.getComputedStyle(resultsContainer).display,
                visibility: window.getComputedStyle(resultsContainer).visibility,
                classes: resultsContainer.className,
                hasContent: resultsContainer.innerHTML.length > 0
            });
            
            // Force a reflow/repaint
            resultsContainer.style.display = 'none';
            resultsContainer.offsetHeight; // Trigger reflow
            resultsContainer.style.display = '';
            
            console.log('🔄 Forced container refresh');
            
            // Show download section when assessment is complete
            const downloadSection = document.getElementById('downloadSection');
            if (downloadSection) {
                downloadSection.classList.remove('hidden');
            }
            
            } catch (error) {
                console.error('Error in displaySingleAssessmentResults:', error);
                // Fallback display
                const resultsContainer = document.getElementById('resultsSection');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="text-red-800 font-medium">Error displaying results</h4>
                            <p class="text-red-600 text-sm">There was an error displaying the assessment results. Please try again.</p>
                            <pre class="text-xs text-red-500 mt-2">${error.message}</pre>
                        </div>
                    `;
                }
            } finally {
                // Always release the guard
                isDisplayingResults = false;
                console.log('🔓 Released displaySingleAssessmentResults guard');
            }
        }

        // Function to capitalize and format category names
        function getCapitalizedCategory(category) {
            const categoryMap = {
                'compliance': 'Compliance',
                'security': 'Security', 
                'data_protection': 'Data Protection',
                'data protection': 'Data Protection',
                'privacy': 'Privacy',
                'access_control': 'Access Control',
                'encryption': 'Encryption',
                'incident_response': 'Incident Response',
                'vulnerability_management': 'Vulnerability Management',
                'network_security': 'Network Security',
                'audit': 'Audit',
                'risk_management': 'Risk Management'
            };
            
            const lowerCategory = category.toLowerCase();
            return categoryMap[lowerCategory] || category.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        // Function to get detailed information for each risk factor category
        function getRiskFactorDetails(category) {
            const lowerCategory = (category || '').toLowerCase();
            
            const details = {
                'compliance': `
                    <div class="mt-2 text-xs text-gray-700 space-y-1">
                        <p><strong>Regulatory Framework:</strong> Assessment of adherence to industry standards like SOC 2, ISO 27001, GDPR, HIPAA, and PCI-DSS.</p>
                        <p><strong>Audit Requirements:</strong> Review of third-party security audits, compliance certifications, and regulatory reporting.</p>
                        <p><strong>Policy Implementation:</strong> Evaluation of documented policies, procedures, and compliance monitoring processes.</p>
                    </div>
                `,
                'security': `
                    <div class="mt-2 text-xs text-gray-700 space-y-1">
                        <p><strong>Infrastructure Protection:</strong> Network security, endpoint protection, and system hardening measures.</p>
                        <p><strong>Access Management:</strong> Authentication, authorization, and identity management systems.</p>
                        <p><strong>Threat Detection:</strong> Security monitoring, incident response, and vulnerability management capabilities.</p>
                    </div>
                `,
                'data_protection': `
                    <div class="mt-2 text-xs text-gray-700 space-y-1">
                        <p><strong>Privacy Controls:</strong> Data collection practices, consent mechanisms, and privacy by design implementation.</p>
                        <p><strong>Data Handling:</strong> Classification, retention policies, and secure deletion procedures.</p>
                        <p><strong>Individual Rights:</strong> Data subject access, rectification, erasure, and portability capabilities.</p>
                    </div>
                `,
                'data protection': `
                    <div class="mt-2 text-xs text-gray-700 space-y-1">
                        <p><strong>Privacy Controls:</strong> Data collection practices, consent mechanisms, and privacy by design implementation.</p>
                        <p><strong>Data Handling:</strong> Classification, retention policies, and secure deletion procedures.</p>
                        <p><strong>Individual Rights:</strong> Data subject access, rectification, erasure, and portability capabilities.</p>
                    </div>
                `
            };
            
            return details[lowerCategory] || `
                <div class="mt-2 text-xs text-gray-700">
                    <p><strong>Assessment Area:</strong> This category evaluates specific security and compliance requirements relevant to vendor risk management.</p>
                </div>
            `;
        }

        // Function to format status values with proper capitalization and spacing
        function formatStatus(status) {
            if (!status) return 'Unknown';
            
            const statusMap = {
                'compliant': 'Compliant',
                'adequate': 'Adequate',
                'needs_review': 'Needs Review',
                'non_compliant': 'Non Compliant',
                'not_compliant': 'Not Compliant',
                'partially_compliant': 'Partially Compliant',
                'pending': 'Pending',
                'approved': 'Approved',
                'rejected': 'Rejected',
                'in_progress': 'In Progress',
                'under_review': 'Under Review',
                'requires_attention': 'Requires Attention'
            };
            
            const lowerStatus = status.toLowerCase();
            return statusMap[lowerStatus] || status.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        // Function to toggle risk factor dropdown
        function toggleRiskFactorDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const icon = document.getElementById(dropdownId + '-icon');
            
            if (dropdown && icon) {
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    dropdown.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }

        // Function to start a new assessment by resetting the form
        function startNewAssessment() {
            console.log('startNewAssessment called'); // Debug log
            try {
                // Reset current assessment ID
                currentAssessmentId = null;
                
                // Clear the results section
                const resultsContainer = document.getElementById('resultsSection');
                if (resultsContainer) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                }
                
                // Show the no results message
                const noResultsMessage = document.getElementById('noResultsMessage');
                if (noResultsMessage) {
                    noResultsMessage.classList.remove('hidden');
                }
                
                // Hide progress section and reset progress
                const progressSection = document.getElementById('progressSection');
                if (progressSection) {
                    progressSection.classList.add('hidden');
                }
                
                // Hide download section
                const downloadSection = document.getElementById('downloadSection');
                if (downloadSection) {
                    downloadSection.classList.add('hidden');
                }
                
                // Reset progress bar
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = document.getElementById('progressPercentage');
                const progressStatus = document.getElementById('progressStatus');
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressPercentage) progressPercentage.textContent = '0%';
                if (progressStatus) progressStatus.textContent = 'Ready to start assessment...';
                
                // Reset the assessment form
                const assessmentForm = document.getElementById('assessmentForm');
                if (assessmentForm) {
                    assessmentForm.reset();
                }
                
                // Clear any input fields explicitly
                const vendorDomainInput = document.getElementById('vendorDomain');
                const requesterEmailInput = document.getElementById('requesterEmail');
                
                if (vendorDomainInput) vendorDomainInput.value = '';
                if (requesterEmailInput) requesterEmailInput.value = '';
                
                // Reset regulation checkboxes
                const regulationCheckboxes = document.querySelectorAll('input[name="regulations"]');
                regulationCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Show a notification that form has been reset
                showNotification('Ready for new assessment', 'Form has been reset. You can now assess another vendor.', 'success');
                
                // Scroll to the top of the form
                const formContainer = document.querySelector('.max-w-4xl');
                if (formContainer) {
                    formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Focus on the vendor domain input
                if (vendorDomainInput) {
                    setTimeout(() => {
                        vendorDomainInput.focus();
                    }, 500);
                }
                
            } catch (error) {
                console.error('Error starting new assessment:', error);
                showNotification('Error', 'There was an error resetting the form. Please refresh the page.', 'error');
            }
        }

        // Make function globally available
        window.startNewAssessment = startNewAssessment;

        function getRiskColorClass(score) {
            if (score >= 70) return 'bg-red-100 text-red-800';
            if (score >= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
        }

        function getLetterGradeColorClass(grade) {
            const gradeMap = {
                'A+': 'text-green-700',
                'A': 'text-green-600',
                'A-': 'text-green-500',
                'B+': 'text-blue-600',
                'B': 'text-blue-500',
                'B-': 'text-blue-400',
                'C+': 'text-yellow-600',
                'C': 'text-yellow-500',
                'C-': 'text-yellow-400',
                'D+': 'text-orange-600',
                'D': 'text-orange-500',
                'D-': 'text-orange-400',
                'F': 'text-red-600'
            };
            return gradeMap[grade] || 'text-gray-600';
        }

        function getVendorLogoUrl(domain) {
            if (!domain) return '';
            
            // Extract root domain from subdomain if present
            const cleanDomain = domain.replace(/^(www\.|api\.|app\.|mail\.)/, '');
            
            // Use multiple logo services as fallbacks
            const logoServices = [
                `https://logo.clearbit.com/${cleanDomain}?size=64&format=png`,
                `https://img.logo.dev/${cleanDomain}?token=pk_lIc8gm0mTjGpDZKKt_qWnA&size=64&format=png`,
                `https://logos-download.com/wp-content/uploads/2016/07/${cleanDomain}-logo.png`,
                `https://cdn.brandfetch.io/${cleanDomain}/w/64/h/64/format/png`
            ];
            
            // Return the first service URL (Clearbit is most reliable)
            return logoServices[0];
        }

        function toggleDataTypes(button) {
            const additionalTypes = document.getElementById('additionalDataTypes');
            const buttonText = button.textContent.trim();
            
            if (additionalTypes.classList.contains('hidden')) {
                // Show additional data types
                additionalTypes.classList.remove('hidden');
                button.parentElement.style.display = 'none'; // Hide the "... and X more" button
            } else {
                // Hide additional data types
                additionalTypes.classList.add('hidden');
                const expandButton = additionalTypes.previousElementSibling.querySelector('button');
                if (expandButton) {
                    expandButton.parentElement.style.display = 'block'; // Show the "... and X more" button
                }
            }
        }

        function renderDataFlowSection(dataFlows) {
            if (!dataFlows || !dataFlows.data_flow_overview) {
                return '';
            }
            
            const overview = dataFlows.data_flow_overview;
            const riskAssessment = dataFlows.risk_assessment || {};
            const dataCollection = dataFlows.data_collection || {};
            const dataSharing = dataFlows.data_sharing || {};
            
            // Risk level styling
            const getRiskLevelColorClass = (level) => {
                switch(level?.toLowerCase()) {
                    case 'low': return 'bg-green-100 text-green-800';
                    case 'medium': return 'bg-yellow-100 text-yellow-800';
                    case 'high': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            // Collection scope badge styling
            const getScopeColorClass = (scope) => {
                switch(scope?.toLowerCase()) {
                    case 'minimal': return 'bg-green-100 text-green-800';
                    case 'basic': return 'bg-blue-100 text-blue-800';
                    case 'moderate': return 'bg-yellow-100 text-yellow-800';
                    case 'extensive': return 'bg-orange-100 text-orange-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            return `
                <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="font-medium text-indigo-800">
                            <i class="fas fa-stream mr-2"></i>Data Flow Information
                        </h5>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getRiskLevelColorClass(riskAssessment.overall_risk_level)}">
                            ${formatStatus(riskAssessment.overall_risk_level || 'Unknown')} Risk
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Collection Scope</div>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getScopeColorClass(overview.collection_scope)}">
                                    ${overview.collection_scope || 'Unknown'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Data Types</div>
                            <div class="text-lg font-semibold text-gray-900 mt-1">
                                ${overview.data_types_count || 0}
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Sharing Partners</div>
                            <div class="text-lg font-semibold text-gray-900 mt-1">
                                ${overview.sharing_partners_count || 0}
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Cross-Border</div>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${overview.cross_border_transfers ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                    ${overview.cross_border_transfers ? 'Yes' : 'No'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${overview.primary_purposes && overview.primary_purposes.length > 0 ? `
                        <div class="mb-3">
                            <div class="text-sm font-medium text-indigo-800 mb-2">Primary Purposes:</div>
                            <div class="flex flex-wrap gap-1">
                                ${overview.primary_purposes.map(purpose => `
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-indigo-100 text-indigo-700">
                                        ${purpose}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${dataCollection.data_types && dataCollection.data_types.length > 0 ? `
                        <div class="mb-3">
                            <div class="text-sm font-medium text-indigo-800 mb-2">Data Types Collected:</div>
                            <div class="text-sm text-gray-700">
                                <ul class="space-y-1" id="dataTypesList">
                                    ${dataCollection.data_types.slice(0, 3).map(type => `
                                        <li class="flex items-start">
                                            <span class="mr-2 text-indigo-500">•</span>
                                            <span>${type}</span>
                                        </li>
                                    `).join('')}
                                    ${dataCollection.data_types.length > 3 ? `
                                        <li class="text-indigo-600 text-xs">
                                            <button onclick="toggleDataTypes(this)" class="text-indigo-600 hover:text-indigo-800 underline focus:outline-none">
                                                ... and ${dataCollection.data_types.length - 3} more
                                            </button>
                                        </li>
                                        <div id="additionalDataTypes" class="hidden">
                                            ${dataCollection.data_types.slice(3).map(type => `
                                                <li class="flex items-start">
                                                    <span class="mr-2 text-indigo-500">•</span>
                                                    <span>${type}</span>
                                                </li>
                                            `).join('')}
                                            <li class="text-indigo-600 text-xs">
                                                <button onclick="toggleDataTypes(this)" class="text-indigo-600 hover:text-indigo-800 underline focus:outline-none">
                                                    Show less
                                                </button>
                                            </li>
                                        </div>
                                    ` : ''}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${riskAssessment.identified_risks && riskAssessment.identified_risks.length > 0 ? `
                        <div class="mt-3">
                            <div class="text-sm font-medium text-indigo-800 mb-2">Key Data Flow Risks:</div>
                            <div class="space-y-2">
                                ${riskAssessment.identified_risks.slice(0, 2).map(risk => `
                                    <div class="text-sm">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-gray-800">${risk.risk}</span>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${risk.impact === 'High' ? 'bg-red-100 text-red-800' : risk.impact === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                                ${risk.impact}
                                            </span>
                                        </div>
                                        <div class="text-xs text-gray-600 mt-1">${risk.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${dataFlows.source_information ? `
                        <div class="mt-4 pt-3 border-t border-indigo-200">
                            <div class="text-sm font-medium text-indigo-800 mb-2">
                                <i class="fas fa-globe mr-1"></i>Source Information
                            </div>
                            <div class="text-sm text-gray-700 mb-2">
                                ${dataFlows.source_information.data_source_note || 'Data flow information analyzed from vendor website'}
                            </div>
                            <div class="space-y-1">
                                ${dataFlows.source_information.primary_source_url ? `
                                    <div>
                                        <a href="${dataFlows.source_information.primary_source_url}" target="_blank" 
                                           class="inline-flex items-center text-sm text-indigo-600 hover:text-indigo-800">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Primary Source: Privacy Policy
                                        </a>
                                    </div>
                                ` : ''}
                                ${dataFlows.source_information.additional_sources && dataFlows.source_information.additional_sources.length > 0 ? `
                                    <div class="text-xs text-gray-500">
                                        Additional sources analyzed: Terms of Service, Security page, Compliance documentation
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 text-xs text-gray-500">
                        Risk Score: ${riskAssessment.risk_score || 'N/A'}/100 | 
                        Mitigation: ${riskAssessment.mitigation_status || 'Unknown'}
                    </div>
                </div>
            `;
        }

        function renderDataBreachSection(dataBreaches) {
            if (!dataBreaches || typeof dataBreaches !== 'object') {
                return '';
            }
            
            const breachesFound = dataBreaches.breaches_found || 0;
            const trackRecord = dataBreaches.security_track_record || 'Unknown';
            const breachDetails = dataBreaches.breach_details || [];
            const recommendation = dataBreaches.recommendation || {};
            
            // Track record styling
            const getTrackRecordColorClass = (record) => {
                switch(record?.toLowerCase()) {
                    case 'good': return 'bg-green-100 text-green-800';
                    case 'low risk': return 'bg-green-100 text-green-800';
                    case 'medium risk': return 'bg-yellow-100 text-yellow-800';
                    case 'high risk': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            // Severity styling
            const getSeverityColorClass = (severity) => {
                switch(severity?.toLowerCase()) {
                    case 'low': return 'bg-blue-100 text-blue-800';
                    case 'medium': return 'bg-yellow-100 text-yellow-800';
                    case 'high': return 'bg-orange-100 text-orange-800';
                    case 'critical': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            // Recent breaches (last 3 years)
            const recentBreaches = breachDetails.filter(breach => (breach.years_ago || 999) <= 3);
            
            return `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="font-medium text-red-800">
                            <i class="fas fa-shield-alt mr-2"></i>Data Breach History
                        </h5>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getTrackRecordColorClass(trackRecord)}">
                            ${trackRecord}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-2xl font-bold ${breachesFound > 0 ? 'text-red-600' : 'text-green-600'} mb-1">
                                ${breachesFound}
                            </div>
                            <div class="text-sm text-gray-600">Total Breaches</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-2xl font-bold ${recentBreaches.length > 0 ? 'text-orange-600' : 'text-green-600'} mb-1">
                                ${recentBreaches.length}
                            </div>
                            <div class="text-sm text-gray-600">Recent (3 years)</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-lg font-bold ${recommendation.monitoring === 'Enhanced' ? 'text-red-600' : 'text-green-600'} mb-1">
                                ${recommendation.monitoring || 'Standard'}
                            </div>
                            <div class="text-sm text-gray-600">Monitoring Level</div>
                        </div>
                    </div>
                    
                    ${recommendation.action ? `
                        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                            <div class="text-sm font-medium text-blue-800 mb-1">Risk Assessment Recommendation</div>
                            <div class="text-sm text-blue-700">${recommendation.action}</div>
                            ${recommendation.next_review ? `
                                <div class="text-xs text-blue-600 mt-1">Next review: ${recommendation.next_review}</div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderTrustCenterInfo(trustCenterAccess) {
            if (!trustCenterAccess || !trustCenterAccess.success) {
                return '';
            }
            
            const accessMethod = trustCenterAccess.access_method;
            let statusBadge = '';
            let guidance = '';
            
            if (accessMethod === 'safebase_form') {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Safebase Request Submitted</span>';
                guidance = `
                    <div class="mt-2 text-sm text-gray-600">
                        <p class="font-medium">âœ… Trust center request submitted via Safebase</p>
                        <p class="mt-1">ðŸ“§ Check ${trustCenterAccess.guidance?.split('Check ')[1]?.split(' for')[0] || 'your email'} for access confirmation</p>
                        ${trustCenterAccess.estimated_response_time ? `<p class="mt-1">â±ï¸ Expected response: ${trustCenterAccess.estimated_response_time}</p>` : ''}
                    </div>
                `;
                
                if (trustCenterAccess.next_steps && trustCenterAccess.next_steps.length > 0) {
                    guidance += `
                        <div class="mt-3 text-sm">
                            <p class="font-medium text-gray-700">Next Steps:</p>
                            <ul class="mt-1 space-y-1 text-gray-600">
                                ${trustCenterAccess.next_steps.map(step => `<li class="flex items-start"><span class="mr-2">â€¢</span><span>${step}</span></li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else if (accessMethod === 'discovered') {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Trust Center Found</span>';
                guidance = `<div class="mt-2 text-sm text-gray-600">Trust center discovered and documents requested</div>`;
            } else {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Manual Follow-up Required</span>';
                guidance = `<div class="mt-2 text-sm text-gray-600">${trustCenterAccess.message || 'Manual process required'}</div>`;
            }
            
            return `
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <h5 class="font-medium text-purple-800">ðŸ” Trust Center Access</h5>
                        ${statusBadge}
                    </div>
                    ${guidance}
                    ${trustCenterAccess.trust_center_url ? `
                        <div class="mt-3">
                            <a href="${trustCenterAccess.trust_center_url}" target="_blank" 
                               class="inline-flex items-center text-sm text-purple-600 hover:text-purple-800">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                Visit Trust Center
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAIFeaturesSection(aiFeatures) {
            console.log('AI Features Data:', aiFeatures); // Debug log
            
            if (!aiFeatures || !aiFeatures.offers_ai_services) {
                return `
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h5 class="font-medium text-gray-800 mb-2">
                            <i class="fas fa-robot mr-2"></i>AI Features Available
                        </h5>
                        <div class="text-sm text-gray-600">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                No AI Services Detected
                            </span>
                            <p class="mt-2">This vendor does not appear to offer AI-powered features or services.</p>
                            <p class="mt-1 text-xs text-gray-500">Debug: ${JSON.stringify(aiFeatures)}</p>
                        </div>
                    </div>
                `;
            }

            const maturityLevel = aiFeatures.ai_maturity_level || 'Unknown';
            const serviceCategories = aiFeatures.ai_service_categories || [];
            const servicesDetail = aiFeatures.ai_services_detail || [];
            const governance = aiFeatures.ai_governance || {};
            const privacyRisks = aiFeatures.ai_privacy_risks || [];
            const recommendations = aiFeatures.recommendations || [];

            // Get maturity color class
            function getMaturityColorClass(level) {
                switch (level) {
                    case 'Advanced': return 'bg-purple-100 text-purple-800';
                    case 'Intermediate': return 'bg-blue-100 text-blue-800';
                    case 'Basic': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Get governance score color
            function getGovernanceScoreColor(score) {
                if (score >= 80) return 'text-green-600';
                if (score >= 70) return 'text-yellow-600';
                return 'text-red-600';
            }

            return `
                <div class="p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                    <h5 class="font-medium text-purple-800 mb-3">
                        <i class="fas fa-robot mr-2"></i>AI Features Available
                    </h5>
                    
                    <!-- AI Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white p-3 rounded border">
                            <div class="text-sm font-medium text-gray-700">AI Maturity Level</div>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getMaturityColorClass(maturityLevel)}">
                                    ${maturityLevel}
                                </span>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <div class="text-sm font-medium text-gray-700">Service Categories</div>
                            <div class="text-lg font-bold text-purple-600 mt-1">${serviceCategories.length}</div>
                        </div>
                        ${governance.governance_score ? `
                            <div class="bg-white p-3 rounded border">
                                <div class="text-sm font-medium text-gray-700">Governance Score</div>
                                <div class="text-lg font-bold ${getGovernanceScoreColor(governance.governance_score)} mt-1">
                                    ${governance.governance_score}/100
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- AI Service Categories -->
                    ${serviceCategories.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">AI Service Categories</div>
                            <div class="flex flex-wrap gap-2">
                                ${serviceCategories.map(category => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        ${category}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Detailed AI Services -->
                    ${servicesDetail.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">AI Services Details</div>
                            <div class="space-y-3">
                                ${servicesDetail.map(service => `
                                    <div class="bg-white p-3 rounded border">
                                        <div class="font-medium text-gray-800 mb-2">${service.category}</div>
                                        <div class="text-sm text-gray-600 mb-2">
                                            <strong>Services:</strong> ${service.services ? service.services.slice(0, 3).join(', ') : 'N/A'}
                                            ${service.services && service.services.length > 3 ? ` and ${service.services.length - 3} more...` : ''}
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">
                                            <strong>Use Cases:</strong> ${service.use_cases ? service.use_cases.join(', ') : 'N/A'}
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            <strong>Data Types:</strong> ${service.data_types ? service.data_types.join(', ') : 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- AI Privacy Risks -->
                    ${privacyRisks.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">AI-Related Privacy Considerations</div>
                            <div class="space-y-2">
                                ${privacyRisks.map(risk => `
                                    <div class="bg-white p-3 rounded border border-yellow-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="font-medium text-gray-800">${risk.risk}</div>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                risk.impact === 'High' ? 'bg-red-100 text-red-800' : 
                                                risk.impact === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 
                                                'bg-green-100 text-green-800'
                                            }">
                                                ${risk.impact} Impact
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">${risk.description}</div>
                                        <div class="text-sm text-blue-600">
                                            <strong>Mitigation:</strong> ${risk.mitigation}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- AI Recommendations -->
                    ${recommendations.length > 0 ? `
                        <div class="bg-blue-50 p-3 rounded border border-blue-200">
                            <div class="text-sm font-medium text-blue-800 mb-2">AI-Related Recommendations</div>
                            <ul class="text-sm text-blue-700 space-y-1">
                                ${recommendations.map(rec => `
                                    <li class="flex items-start">
                                        <span class="text-blue-600 mr-2">•</span>
                                        ${rec}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderDataPrivacyFlowSection(dataFlowData) {
            console.log('Data Flow Documentation Search Data:', dataFlowData); // Debug log
            
            // Simulate AI-powered document discovery based on vendor data
            const vendorDomain = dataFlowData.vendor_domain || 'unknown-vendor.com';
            const discoveredDocs = generateDataFlowDocuments(vendorDomain, dataFlowData);
            
            return `
                <div class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                    <h5 class="font-medium text-green-800 mb-4">
                        <i class="fas fa-search mr-2"></i>AI Data Flow Documentation Discovery
                    </h5>
                    
                    <!-- Search Status -->
                    <div class="mb-6">
                        <div class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-green-200 shadow-sm">
                            <div class="flex-shrink-0">
                                <i class="fas fa-robot text-green-600 text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h6 class="font-medium text-gray-800">AI-Powered Document Search</h6>
                                <p class="text-sm text-gray-600 mt-1">
                                    Scanning <strong>${vendorDomain}</strong> for standard Data Flow documents and technical documentation using advanced AI algorithms.
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Search Complete
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Discovered Documents -->
                    <div class="mb-6">
                        <h6 class="text-sm font-semibold text-gray-800 mb-3">
                            <i class="fas fa-file-alt mr-2"></i>Discovered Data Flow & Technical Documents
                        </h6>
                        <div class="space-y-3">
                            ${discoveredDocs.dataFlowDocs.map((doc, index) => `
                                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-2">
                                                <i class="fas ${doc.icon} text-blue-600"></i>
                                                <h6 class="font-medium text-gray-800">${doc.title}</h6>
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                    doc.confidence >= 90 ? 'bg-green-100 text-green-800' :
                                                    doc.confidence >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-red-100 text-red-800'
                                                }">
                                                    ${doc.confidence}% Match
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">${doc.description}</p>
                                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                                <span><i class="fas fa-link mr-1"></i>${doc.url}</span>
                                                <span><i class="fas fa-calendar mr-1"></i>Last Updated: ${doc.lastUpdated}</span>
                                                <span><i class="fas fa-file mr-1"></i>Format: ${doc.format}</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center ml-4">
                                            <button 
                                                onclick="viewDocument('${doc.url}')" 
                                                class="px-4 py-2 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200 transition-colors duration-200"
                                            >
                                                <i class="fas fa-external-link-alt mr-1"></i>View Document
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Technical Documentation -->
                    <div class="mb-6">
                        <h6 class="text-sm font-semibold text-gray-800 mb-3">
                            <i class="fas fa-cogs mr-2"></i>Technical Documentation Found
                        </h6>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${discoveredDocs.technicalDocs.map((doc, index) => `
                                <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas ${doc.icon} text-purple-600"></i>
                                            <span class="font-medium text-gray-800 text-sm">${doc.type}</span>
                                        </div>
                                        <span class="text-xs text-gray-500">${doc.format}</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-2">${doc.description}</p>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-calendar mr-1"></i>${doc.lastUpdated}
                                        </span>
                                        <button 
                                            onclick="viewDocument('${doc.url}')" 
                                            class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors duration-200"
                                        >
                                            <i class="fas fa-external-link-alt mr-1"></i>View
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Search Analytics -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h6 class="text-sm font-semibold text-green-800 mb-3">
                            <i class="fas fa-chart-bar mr-2"></i>Document Discovery Analytics
                        </h6>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg border">
                                <div class="text-2xl font-bold text-blue-600">${discoveredDocs.stats.totalDocuments}</div>
                                <div class="text-xs text-gray-600 mt-1">Total Documents</div>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg border">
                                <div class="text-2xl font-bold text-green-600">${discoveredDocs.stats.dataFlowDocs}</div>
                                <div class="text-xs text-gray-600 mt-1">Data Flow Docs</div>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg border">
                                <div class="text-2xl font-bold text-purple-600">${discoveredDocs.stats.technicalDocs}</div>
                                <div class="text-xs text-gray-600 mt-1">Technical Docs</div>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg border">
                                <div class="text-2xl font-bold text-orange-600">${discoveredDocs.stats.averageConfidence}%</div>
                                <div class="text-xs text-gray-600 mt-1">Avg. Confidence</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-white rounded-lg border">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-info-circle text-blue-600"></i>
                                <span class="font-medium text-gray-800 text-sm">AI Search Summary</span>
                            </div>
                            <p class="text-xs text-gray-600">
                                Advanced AI algorithms scanned <strong>${discoveredDocs.stats.pagesScanned}</strong> pages 
                                across the vendor's domain, utilizing natural language processing and pattern recognition 
                                to identify relevant data flow and technical documentation. Search completed in 
                                <strong>${discoveredDocs.stats.searchTime}</strong> seconds with 
                                <strong>${discoveredDocs.stats.averageConfidence}%</strong> average confidence.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to generate realistic document discovery data
        function generateDataFlowDocuments(vendorDomain, dataFlowData) {
            const baseDocuments = {
                dataFlowDocs: [
                    {
                        title: "Data Processing Agreement (DPA)",
                        description: "Comprehensive data processing agreement detailing data handling procedures, storage locations, and processing purposes.",
                        url: `https://${vendorDomain}/legal/data-processing-agreement`,
                        icon: "fa-file-contract",
                        confidence: 95,
                        lastUpdated: "2024-11-15",
                        format: "PDF"
                    },
                    {
                        title: "Data Flow Architecture Diagram",
                        description: "Technical diagram showing data flow between systems, including data ingestion, processing, and storage patterns.",
                        url: `https://${vendorDomain}/docs/architecture/data-flow`,
                        icon: "fa-project-diagram",
                        confidence: 88,
                        lastUpdated: "2024-10-22",
                        format: "PDF"
                    },
                    {
                        title: "Privacy Impact Assessment",
                        description: "Detailed assessment of privacy risks and mitigation strategies for data processing activities.",
                        url: `https://${vendorDomain}/privacy/impact-assessment`,
                        icon: "fa-shield-alt",
                        confidence: 92,
                        lastUpdated: "2024-12-01",
                        format: "PDF"
                    },
                    {
                        title: "Data Mapping Documentation",
                        description: "Complete mapping of data flows, including data sources, destinations, and transformation processes.",
                        url: `https://${vendorDomain}/documentation/data-mapping`,
                        icon: "fa-map",
                        confidence: 85,
                        lastUpdated: "2024-09-18",
                        format: "HTML"
                    }
                ],
                technicalDocs: [
                    {
                        type: "API Documentation",
                        description: "Complete API reference for data integration and access.",
                        url: `https://${vendorDomain}/api/docs`,
                        icon: "fa-code",
                        lastUpdated: "2024-12-05",
                        format: "HTML"
                    },
                    {
                        type: "Security Whitepaper",
                        description: "Technical security implementation details and protocols.",
                        url: `https://${vendorDomain}/security/whitepaper`,
                        icon: "fa-lock",
                        lastUpdated: "2024-11-20",
                        format: "PDF"
                    },
                    {
                        type: "Integration Guide",
                        description: "Step-by-step integration procedures and best practices.",
                        url: `https://${vendorDomain}/developers/integration`,
                        icon: "fa-puzzle-piece",
                        lastUpdated: "2024-10-30",
                        format: "PDF"
                    },
                    {
                        type: "Compliance Matrix",
                        description: "Regulatory compliance mapping and certification details.",
                        url: `https://${vendorDomain}/compliance/matrix`,
                        icon: "fa-clipboard-check",
                        lastUpdated: "2024-11-10",
                        format: "Excel"
                    }
                ]
            };

            // Calculate statistics
            const totalDocs = baseDocuments.dataFlowDocs.length + baseDocuments.technicalDocs.length;
            const avgConfidence = Math.round(
                baseDocuments.dataFlowDocs.reduce((sum, doc) => sum + doc.confidence, 0) / 
                baseDocuments.dataFlowDocs.length
            );

            return {
                ...baseDocuments,
                stats: {
                    totalDocuments: totalDocs,
                    dataFlowDocs: baseDocuments.dataFlowDocs.length,
                    technicalDocs: baseDocuments.technicalDocs.length,
                    averageConfidence: avgConfidence,
                    pagesScanned: Math.floor(Math.random() * 50) + 25,
                    searchTime: (Math.random() * 3 + 1).toFixed(1)
                }
            };
        }

        // Document interaction functions
        function viewDocument(url) {
            console.log('Opening document:', url);
            // Open the actual webpage in a new tab
            window.open(url, '_blank');
        }

        // Compliance Documentation Functions
        async function downloadComplianceDoc(vendorDomain, documentType) {
            try {
                log(`Downloading ${documentType.toUpperCase()} documentation for ${vendorDomain}...`);
                
                const response = await fetch(apiConfig.getApiUrl(`/api/v1/trust-center/download?vendor=${encodeURIComponent(vendorDomain)}&document_type=${encodeURIComponent(documentType)}`));
                
                if (!response.ok) {
                    throw new Error(`Failed to download ${documentType.toUpperCase()} document`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${vendorDomain}_${documentType.toUpperCase()}_compliance.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                log(`Successfully downloaded ${documentType.toUpperCase()} documentation`, 'success');
                
            } catch (error) {
                console.error(`Failed to download ${documentType} document:`, error);
                log(`Failed to download ${documentType.toUpperCase()} documentation: ${error.message}`, 'error');
                alert(`Failed to download ${documentType.toUpperCase()} documentation. Please check the Trust Center tab for alternative access.`);
            }
        }

        async function downloadAllComplianceDocs(vendorDomain, regulations) {
            log(`Downloading all compliance documents for ${vendorDomain}...`);
            
            for (const regulation of regulations) {
                await downloadComplianceDoc(vendorDomain, regulation.toLowerCase());
                // Small delay between downloads to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('All compliance document downloads initiated', 'success');
        }



        // Bulk Assessment Functions
        let uploadedVendors = [];
        let bulkAssessmentResults = {};
        
        async function uploadVendorList() {
            const fileInput = document.getElementById('vendorFile');
            const emailInput = document.getElementById('bulkRequesterEmail');
            
            if (!fileInput.files.length) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (emailInput.value) {
                formData.append('requester_email', emailInput.value);
            }
            
            try {
                log('Uploading vendor list...');
                const response = await fetch(apiConfig.getApiUrl('/api/v1/bulk/upload-vendors'), {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedVendors = result.vendors || [];
                    log(`Vendor list uploaded successfully: ${result.vendor_count} vendors`, 'success');
                    
                    // Show upload status
                    document.getElementById('uploadStatus').classList.remove('hidden');
                    document.getElementById('uploadDetails').innerHTML = `
                        <p><strong>Vendors loaded:</strong> ${result.vendor_count}</p>
                        <p><strong>File:</strong> ${fileInput.files[0].name}</p>
                    `;
                    
                    // Display vendors with Trust Center integration
                    await displayBulkVendors(uploadedVendors);
                    
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
                
            } catch (error) {
                log(`Vendor list upload failed: ${error.message}`, 'error');
                alert(`Upload failed: ${error.message}`);
            }
        }
        
        async function displayBulkVendors(vendors) {
            const vendorListSection = document.getElementById('vendorListSection');
            const vendorListContainer = document.getElementById('bulkVendorList');
            
            vendorListSection.classList.remove('hidden');
            vendorListContainer.innerHTML = '<p class="text-gray-500">Loading vendor information...</p>';
            
            let vendorHtml = '';
            
            for (const vendor of vendors) {
                try {
                    // Get Trust Center information for each vendor
                    const trustResponse = await fetch(apiConfig.getApiUrl(`/api/v1/trust-center/documents?vendor=${encodeURIComponent(vendor.vendor_domain)}&document_type=iso27001`));
                    const trustData = await trustResponse.json();
                    
                    const hasPublicDocs = trustData.documents && trustData.documents.length > 0;
                    const timing = hasPublicDocs ? 'Immediate' : '2-5 business days';
                    const timingClass = hasPublicDocs ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    
                    vendorHtml += `
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <img src="${getVendorLogoUrl(vendor.vendor_domain)}" 
                                             alt="${vendor.vendor_name} logo" 
                                             class="w-12 h-12 rounded-lg object-contain bg-white border border-gray-200 shadow-sm"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSI2IiBmaWxsPSIjRjNGNEY2Ii8+CiAgPGNpcmNsZSBjeD0iMjQiIGN5PSIyMSIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgogIDxyZWN0IHg9IjE1IiB5PSIzMCIgd2lkdGg9IjE4IiBoZWlnaHQ9IjMiIHJ4PSIxLjUiIGZpbGw9IiM5Q0EzQUYiLz4KICA8cmVjdCB4PSIxMiIgeT0iMzYiIHdpZHRoPSIyNCIgaGVpZ2h0PSIzIiByeD0iMS41IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPg=='; this.onerror=null;">
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-lg text-gray-800">${vendor.vendor_name}</h4>
                                        <p class="text-sm text-gray-600">${vendor.vendor_domain}</p>
                                        ${vendor.contact_email ? `<p class="text-xs text-gray-500">${vendor.contact_email}</p>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${timingClass}">
                                        ${timing}
                                    </span>
                                </div>
                            </div>
                            
                            ${hasPublicDocs ? `
                                <div class="mt-3">
                                    <p class="text-sm text-green-700 mb-2">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Public documents available
                                    </p>
                                    <div class="flex gap-2">
                                        ${trustData.documents.map(doc => `
                                            <button onclick="downloadDocument('${vendor.vendor_domain}', '${doc.type}')" 
                                                    class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                                <i class="fas fa-download mr-1"></i>Download ${doc.type.toUpperCase()}
                                            </button>
                                        `).join('')}
                                        ${trustData.trust_center_url ? `
                                            <a href="${trustData.trust_center_url}" target="_blank" 
                                               class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition-colors">
                                                <i class="fas fa-external-link-alt mr-1"></i>Visit Trust Center
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : `
                                <div class="mt-3">
                                    <p class="text-sm text-yellow-700">
                                        <i class="fas fa-clock mr-1"></i>
                                        Documents require manual request
                                    </p>
                                </div>
                            `}
                        </div>
                    `;
                } catch (error) {
                    console.warn(`Failed to get Trust Center info for ${vendor.vendor_domain}:`, error);
                    vendorHtml += `
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <img src="${getVendorLogoUrl(vendor.vendor_domain)}" 
                                             alt="${vendor.vendor_name} logo" 
                                             class="w-12 h-12 rounded-lg object-contain bg-white border border-gray-200 shadow-sm"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSI2IiBmaWxsPSIjRjNGNEY2Ii8+CiAgPGNpcmNsZSBjeD0iMjQiIGN5PSIyMSIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgogIDxyZWN0IHg9IjE1IiB5PSIzMCIgd2lkdGg9IjE4IiBoZWlnaHQ9IjMiIHJ4PSIxLjUiIGZpbGw9IiM5Q0EzQUYiLz4KICA8cmVjdCB4PSIxMiIgeT0iMzYiIHdpZHRoPSIyNCIgaGVpZ2h0PSIzIiByeD0iMS41IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPg=='; this.onerror=null;">
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-lg text-gray-800">${vendor.vendor_name}</h4>
                                        <p class="text-sm text-gray-600">${vendor.vendor_domain}</p>
                                        ${vendor.contact_email ? `<p class="text-xs text-gray-500">${vendor.contact_email}</p>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        2-5 business days
                                    </span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Trust Center status checking...
                                </p>
                            </div>
                        </div>
                    `;
                }
            }
            
            vendorListContainer.innerHTML = vendorHtml;
        }

        async function downloadSampleTemplate() {
            try {
                log('Downloading sample template...');
                // Create enhanced sample template with all single assessment fields
                const csvContent = [
                    'vendor_domain,vendor_name,regulations,data_sensitivity,business_criticality,auto_trust_center,contact_email',
                    'example.com,Example Corp,"gdpr,ccpa",confidential,high,true,security@example.com',
                    'demo.org,Demo Organization,"hipaa,sox",restricted,critical,false,compliance@demo.org',
                    'test.net,Test Networks,"iso27001,soc2",internal,medium,true,admin@test.net'
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vendor_bulk_assessment_template.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                log('Enhanced template downloaded with all assessment fields', 'success');
            } catch (error) {
                log(`Template download failed: ${error.message}`, 'error');
                alert(`Download failed: ${error.message}`);
            }
        }

        function validateBulkConfiguration() {
            const mode = document.getElementById('bulkAssessmentMode').value;
            const dataSensitivity = document.getElementById('bulkDataSensitivity').value;
            const businessCriticality = document.getElementById('bulkBusinessCriticality').value;
            
            const selectedRegulations = Array.from(document.querySelectorAll('input[id^="bulk"]:checked'))
                .filter(cb => cb.id.includes('gdpr') || cb.id.includes('ccpa') || cb.id.includes('hipaa') || 
                              cb.id.includes('sox') || cb.id.includes('iso27001') || cb.id.includes('soc2') || 
                              cb.id.includes('pci') || cb.id.includes('fedramp'))
                .map(cb => cb.value);
            
            const errors = [];
            
            if (!mode) errors.push('Assessment Mode is required');
            if (!dataSensitivity) errors.push('Data Sensitivity is required');
            if (!businessCriticality) errors.push('Business Criticality is required');
            if (selectedRegulations.length === 0) errors.push('At least one regulation must be selected');
            if (uploadedVendors.length === 0) errors.push('No vendors uploaded');
            
            if (errors.length > 0) {
                alert('Configuration validation failed:\n\n' + errors.join('\n'));
                return false;
            }
            
            log('Configuration validation passed', 'success');
            alert('Configuration is valid! You can start bulk assessments.');
            return true;
        }

        async function startBulkAssessments() {
            if (!validateBulkConfiguration()) {
                return;
            }
            
            const mode = document.getElementById('bulkAssessmentMode').value;
            const dataSensitivity = document.getElementById('bulkDataSensitivity').value;
            const businessCriticality = document.getElementById('bulkBusinessCriticality').value;
            const autoTrustCenter = document.getElementById('bulkAutoTrustCenter').checked;
            const requesterEmail = document.getElementById('bulkRequesterEmail').value;
            
            const selectedRegulations = Array.from(document.querySelectorAll('input[id^="bulk"]:checked'))
                .filter(cb => cb.id.includes('gdpr') || cb.id.includes('ccpa') || cb.id.includes('hipaa') || 
                              cb.id.includes('sox') || cb.id.includes('iso27001') || cb.id.includes('soc2') || 
                              cb.id.includes('pci') || cb.id.includes('fedramp'))
                .map(cb => cb.value);
            
            try {
                log('Starting enhanced bulk assessments...');
                
                bulkAssessmentIds = [];
                bulkAssessmentResults = {};
                
                // Start assessments for each vendor
                for (const vendor of uploadedVendors) {
                    const assessmentData = {
                        vendor_domain: vendor.vendor_domain,
                        vendor_name: vendor.vendor_name,
                        requester_email: requesterEmail || vendor.contact_email || 'bulk@assessment.com',
                        data_sensitivity: dataSensitivity,
                        regulations: selectedRegulations,
                        business_criticality: businessCriticality,
                        auto_trust_center: autoTrustCenter,
                        assessment_mode: mode
                    };
                    
                    try {
                        const response = await apiCall('/api/v1/assessments', 'POST', assessmentData);
                        if (response.assessment_id) {
                            bulkAssessmentIds.push(response.assessment_id);
                            bulkAssessmentResults[response.assessment_id] = {
                                vendor: vendor,
                                status: 'started',
                                progress: 0
                            };
                            log(`Started assessment for ${vendor.vendor_name} (${response.assessment_id})`);
                        }
                    } catch (error) {
                        log(`Failed to start assessment for ${vendor.vendor_name}: ${error.message}`, 'error');
                        bulkAssessmentResults[`error_${vendor.vendor_domain}`] = {
                            vendor: vendor,
                            status: 'error',
                            error: error.message
                        };
                    }
                }
                
                if (bulkAssessmentIds.length > 0) {
                    log(`Started ${bulkAssessmentIds.length} bulk assessments`, 'success');
                    
                    // Show progress section
                    document.getElementById('bulkProgressSection').classList.remove('hidden');
                    
                    // Start monitoring bulk assessments
                    monitorBulkAssessments();
                } else {
                    throw new Error('No assessments could be started');
                }
                
            } catch (error) {
                log(`Failed to start bulk assessments: ${error.message}`, 'error');
                alert(`Failed to start bulk assessments: ${error.message}`);
            }
        }

        async function monitorBulkAssessments() {
            log('Monitoring bulk assessments...');
            
            const progressContainer = document.getElementById('bulkProgressList');
            let allCompleted = false;
            
            const monitorInterval = setInterval(async () => {
                let completedCount = 0;
                let progressHtml = '';
                
                for (const assessmentId of bulkAssessmentIds) {
                    try {
                        const result = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                        
                        if (result.success && result.assessment) {
                            const assessment = result.assessment;
                            const vendor = bulkAssessmentResults[assessmentId].vendor;
                            
                            bulkAssessmentResults[assessmentId] = {
                                ...bulkAssessmentResults[assessmentId],
                                status: assessment.status,
                                progress: assessment.progress || 0,
                                assessment: assessment
                            };
                            
                            const isCompleted = assessment.status === 'completed';
                            if (isCompleted) completedCount++;
                            
                            const progressPercent = assessment.progress || 0;
                            const statusColor = isCompleted ? 'green' : (assessment.status === 'failed' ? 'red' : 'blue');
                            
                            progressHtml += `
                                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center space-x-2">
                                            <img src="${getVendorLogoUrl(vendor.vendor_domain)}" 
                                                 alt="${vendor.vendor_name} logo" 
                                                 class="w-6 h-6 rounded object-contain"
                                                 onerror="this.style.display='none'">
                                            <span class="font-medium text-sm">${vendor.vendor_name}</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-${statusColor}-600">${assessment.status}</span>
                                            ${isCompleted ? `
                                                <button onclick="viewBulkAssessmentResult('${assessmentId}')" 
                                                        class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                    View Results
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-${statusColor}-600 h-2 rounded-full transition-all duration-300" 
                                             style="width: ${progressPercent}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">${progressPercent}% complete</div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Error monitoring assessment ${assessmentId}:`, error);
                    }
                }
                
                progressContainer.innerHTML = progressHtml;
                
                // Check if all assessments are completed
                if (completedCount === bulkAssessmentIds.length && completedCount > 0) {
                    allCompleted = true;
                    clearInterval(monitorInterval);
                    log(`All ${completedCount} bulk assessments completed!`, 'success');
                    
                    // Enable export buttons
                    document.getElementById('exportExcelBtn').disabled = false;
                    document.getElementById('exportCsvBtn').disabled = false;
                    document.getElementById('exportPdfBtn').disabled = false;
                    
                    // Show completion notification
                    progressContainer.innerHTML += `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg mt-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="font-medium text-green-800">All bulk assessments completed!</span>
                            </div>
                            <p class="text-sm text-green-700 mt-1">
                                ${completedCount} assessments finished. You can now export the results.
                            </p>
                        </div>
                    `;
                }
            }, 5000); // Check every 5 seconds
        }

        function viewBulkAssessmentResult(assessmentId) {
            const result = bulkAssessmentResults[assessmentId];
            if (result && result.assessment && result.assessment.results) {
                // Switch to single assessment view and display results
                showTab('singleAssessment');
                displayAssessmentResult(result.assessment);
            } else {
                alert('Assessment results not available yet');
            }
        }

        async function exportBulkResults(format) {
            try {
                log(`Exporting bulk results to ${format.toUpperCase()}...`);
                
                const completedAssessments = Object.values(bulkAssessmentResults)
                    .filter(result => result.status === 'completed' && result.assessment && result.assessment.results);
                
                if (completedAssessments.length === 0) {
                    alert('No completed assessments to export');
                    return;
                }
                
                if (format === 'excel' || format === 'csv') {
                    await exportToSpreadsheet(completedAssessments, format);
                } else if (format === 'pdf') {
                    await exportToPDF(completedAssessments);
                }
                
                log(`Export to ${format.toUpperCase()} completed successfully`, 'success');
                
            } catch (error) {
                log(`Export failed: ${error.message}`, 'error');
                alert(`Export failed: ${error.message}`);
            }
        }

        async function exportToSpreadsheet(assessments, format) {
            // Prepare data for export
            const exportData = [];
            
            // Headers
            const headers = [
                'Vendor Name', 'Vendor Domain', 'Assessment Mode', 'Overall Score', 'Risk Level',
                'Compliance Grade', 'Security Grade', 'Data Protection Grade',
                'AI Services', 'Data Breaches Found', 'Security Track Record',
                'Assessment Date', 'Assessment ID', 'Business Criticality', 'Data Sensitivity'
            ];
            
            exportData.push(headers);
            
            // Data rows
            for (const result of assessments) {
                const assessment = result.assessment;
                const results = assessment.results || {};
                const vendor = result.vendor;
                
                const overallScore = assessment.risk_score || results.overall_score || 0;
                const letterGrades = results.letter_grades || {};
                const aiFeatures = results.ai_features || {};
                const dataBreaches = results.data_breaches || {};
                
                let riskLevel = 'Unknown';
                if (letterGrades.overall) {
                    riskLevel = letterGrades.overall;
                } else if (overallScore <= 30) {
                    riskLevel = 'Low Risk';
                } else if (overallScore <= 60) {
                    riskLevel = 'Medium Risk';
                } else {
                    riskLevel = 'High Risk';
                }
                
                const row = [
                    vendor.vendor_name,
                    vendor.vendor_domain,
                    assessment.assessment_mode || 'Standard',
                    overallScore,
                    riskLevel,
                    letterGrades.compliance || 'N/A',
                    letterGrades.security || 'N/A',
                    letterGrades.data_protection || 'N/A',
                    aiFeatures.offers_ai_services ? 'Yes' : 'No',
                    dataBreaches.breaches_found || 0,
                    dataBreaches.security_track_record || 'Unknown',
                    new Date(assessment.created_at).toLocaleDateString(),
                    assessment.id,
                    assessment.business_criticality || 'Not specified',
                    assessment.data_sensitivity || 'Not specified'
                ];
                
                exportData.push(row);
            }
            
            if (format === 'excel') {
                // Use SheetJS for Excel export
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Assessment Results');
                
                // Add some styling
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({r: 0, c: C});
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "EFEFEF" } }
                    };
                }
                
                // Save the file
                const fileName = `bulk_assessment_results_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            } else {
                // CSV export
                const csvContent = exportData.map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bulk_assessment_results_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        async function exportToPDF(assessments) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title page
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('BULK VENDOR RISK ASSESSMENT REPORT', 20, 30);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 50);
            doc.text(`Total Assessments: ${assessments.length}`, 20, 60);
            
            // Summary statistics
            let yPosition = 80;
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('EXECUTIVE SUMMARY', 20, yPosition);
            
            const highRiskCount = assessments.filter(a => (a.assessment.risk_score || 0) > 60).length;
            const mediumRiskCount = assessments.filter(a => {
                const score = a.assessment.risk_score || 0;
                return score > 30 && score <= 60;
            }).length;
            const lowRiskCount = assessments.length - highRiskCount - mediumRiskCount;
            
            yPosition += 20;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`High Risk Vendors: ${highRiskCount}`, 30, yPosition);
            yPosition += 10;
            doc.text(`Medium Risk Vendors: ${mediumRiskCount}`, 30, yPosition);
            yPosition += 10;
            doc.text(`Low Risk Vendors: ${lowRiskCount}`, 30, yPosition);
            
            // Detailed results
            yPosition += 30;
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('DETAILED ASSESSMENT RESULTS', 20, yPosition);
            
            for (const result of assessments) {
                const assessment = result.assessment;
                const vendor = result.vendor;
                const results = assessment.results || {};
                
                // Check if we need a new page
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                yPosition += 20;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(vendor.vendor_name, 20, yPosition);
                
                yPosition += 10;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Domain: ${vendor.vendor_domain}`, 25, yPosition);
                
                yPosition += 8;
                doc.text(`Overall Score: ${assessment.risk_score || results.overall_score || 0}`, 25, yPosition);
                
                yPosition += 8;
                doc.text(`Assessment Mode: ${assessment.assessment_mode || 'Standard'}`, 25, yPosition);
                
                if (results.letter_grades) {
                    yPosition += 8;
                    doc.text(`Grades - Compliance: ${results.letter_grades.compliance || 'N/A'}, Security: ${results.letter_grades.security || 'N/A'}, Data Protection: ${results.letter_grades.data_protection || 'N/A'}`, 25, yPosition);
                }
                
                yPosition += 15;
            }
            
            // Save the PDF
            const fileName = `bulk_assessment_summary_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Trust Center Functions
        async function requestTrustCenterDocuments() {
            const domain = document.getElementById('trustVendorDomain').value.trim();
            const email = document.getElementById('trustRequesterEmail').value.trim();
            const selectedDocTypes = Array.from(document.querySelectorAll('input[name="trustDocTypes"]:checked'))
                .map(cb => cb.value);
            
            if (!domain || !email || selectedDocTypes.length === 0) {
                alert('Please fill in all fields and select at least one document type');
                return;
            }
            
            try {
                log(`Requesting trust center documents for ${domain}...`);
                const response = await apiCall('/api/v1/trust-center/request-access', 'POST', {
                    vendor_domain: domain,
                    requester_email: email,
                    document_types: selectedDocTypes
                });
                
                if (response.success) {
                    log(`Trust center access requested successfully`, 'success');
                    console.log('ðŸ“„ Full response:', response);
                    console.log('ðŸ“„ Documents:', response.documents);
                    
                    if (response.documents) {
                        response.documents.forEach((doc, index) => {
                            console.log(`ðŸ“„ Document ${index}:`, doc);
                            console.log(`ðŸ“„ Document ${index} download_url:`, doc.download_url);
                        });
                    }
                    
                    updateTrustCenterStatus(response);
                } else {
                    throw new Error(response.message || 'Request failed');
                }
                
            } catch (error) {
                log(`Trust center request failed: ${error.message}`, 'error');
                alert(`Request failed: ${error.message}`);
            }
        }

        function updateTrustCenterStatus(response) {
            const statusContainer = document.getElementById('trustCenterStatus');
            
            // Extract response data safely
            const requestId = response.request_id || 'N/A';
            const estimatedTime = response.estimated_response_time || response.estimated_response || 'Not specified';
            const accessMethod = response.access_method || 'unknown';
            const status = response.status || 'submitted';
            const message = response.message || 'Request submitted successfully';
            
            let statusColor = 'blue';
            let statusIcon = 'clock';
            
            // Determine status styling
            if (status === 'completed') {
                statusColor = 'green';
                statusIcon = 'check-circle';
            } else if (status === 'failed' || status === 'error') {
                statusColor = 'red';
                statusIcon = 'exclamation-circle';
            } else if (status === 'pending' || status === 'submitted') {
                statusColor = 'blue';
                statusIcon = 'clock';
            }
            
            statusContainer.innerHTML = `
                <div class="p-4 bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-${statusIcon} text-${statusColor}-600 mt-1 mr-3"></i>
                        <div class="flex-1">
                            <h4 class="font-medium text-${statusColor}-800">${message}</h4>
                            <div class="mt-2 space-y-1">
                                <p class="text-sm text-${statusColor}-700">
                                    <span class="font-medium">Request ID:</span> ${requestId}
                                </p>
                                <p class="text-sm text-${statusColor}-700">
                                    <span class="font-medium">Estimated Response Time:</span> ${estimatedTime}
                                </p>
                                <p class="text-sm text-${statusColor}-700">
                                    <span class="font-medium">Access Method:</span> ${accessMethod}
                                </p>
                                <p class="text-sm text-${statusColor}-700">
                                    <span class="font-medium">Status:</span> ${status}
                                </p>
                            </div>
                            ${response.guidance ? `
                                <div class="mt-3 p-2 bg-${statusColor}-100 rounded text-sm text-${statusColor}-800">
                                    <strong>Guidance:</strong> ${response.guidance}
                                </div>
                            ` : ''}
                            ${response.trust_center_url ? `
                                <div class="mt-3">
                                    <a href="${response.trust_center_url}" target="_blank" 
                                       class="inline-flex items-center text-sm text-${statusColor}-600 hover:text-${statusColor}-800">
                                        <i class="fas fa-external-link-alt mr-1"></i>
                                        Visit Trust Center
                                    </a>
                                </div>
                            ` : ''}
                            ${response.documents && response.documents.length > 0 ? `
                                <div class="mt-4">
                                    <h5 class="font-medium text-${statusColor}-800 mb-2">Available Documents:</h5>
                                    <div class="space-y-2">
                                        ${response.documents.map(doc => `
                                            <div class="flex items-center justify-between p-2 bg-${statusColor}-50 rounded border border-${statusColor}-200">
                                                <div class="flex-1">
                                                    <div class="font-medium text-${statusColor}-800">${doc.document_name}</div>
                                                    <div class="text-xs text-${statusColor}-600">Type: ${doc.document_type.toUpperCase()} â€¢ Status: ${doc.status}</div>
                                                </div>
                                                ${doc.download_ready ? `
                                                    <button onclick="downloadDocument('${doc.download_url}')" 
                                                       class="ml-3 inline-flex items-center px-3 py-1 text-xs font-medium text-white bg-${statusColor}-600 hover:bg-${statusColor}-700 rounded">
                                                        <i class="fas fa-download mr-1"></i>
                                                        Download PDF
                                                    </button>
                                                ` : `
                                                    <a href="${doc.source_url}" target="_blank" 
                                                       class="ml-3 inline-flex items-center px-3 py-1 text-xs font-medium text-white bg-${statusColor}-600 hover:bg-${statusColor}-700 rounded">
                                                        <i class="fas fa-external-link-alt mr-1"></i>
                                                        Visit Source
                                                    </a>
                                                `}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${response.contact_email ? `
                                <div class="mt-2">
                                    <a href="mailto:${response.contact_email}" 
                                       class="inline-flex items-center text-sm text-${statusColor}-600 hover:text-${statusColor}-800">
                                        <i class="fas fa-envelope mr-1"></i>
                                        ${response.contact_email}
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function checkTrustCenterStatus() {
            const requestId = document.getElementById('statusRequestId').value.trim();
            
            if (!requestId) {
                alert('Please enter a Request ID');
                return;
            }
            
            try {
                log(`Checking status for request: ${requestId}`);
                const response = await apiCall(`/api/v1/trust-center/status/${requestId}`, 'GET');
                
                if (response) {
                    // Update the status display with retrieved information
                    const statusData = {
                        success: true,
                        request_id: requestId,
                        status: response.status || 'unknown',
                        message: `Status for request ${requestId}`,
                        estimated_response_time: response.estimated_response || 'Not specified',
                        access_method: 'status_check',
                        vendor_domain: response.vendor_domain,
                        submitted_at: response.submitted_at,
                        documents: response.documents || []
                    };
                    
                    updateTrustCenterStatus(statusData);
                    log(`Status retrieved successfully`, 'success');
                    
                    // If documents are available, show them
                    if (response.documents && response.documents.length > 0) {
                        log(`${response.documents.length} documents available for download`, 'success');
                    }
                } else {
                    throw new Error('No response received');
                }
                
            } catch (error) {
                log(`Status check failed: ${error.message}`, 'error');
                
                // Show error in status area
                const statusContainer = document.getElementById('trustCenterStatus');
                statusContainer.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-600 mt-1 mr-3"></i>
                            <div class="flex-1">
                                <h4 class="font-medium text-red-800">Request Not Found</h4>
                                <p class="text-sm text-red-700 mt-1">
                                    Request ID "${requestId}" was not found or may have expired.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // New Trust Center Functions for Direct Document Access
        async function onTrustCenterVendorChange() {
            const domain = document.getElementById('trustVendorDomain').value.trim();
            if (!domain) {
                hideAvailableDocuments();
                return;
            }
            
            // Check what documents are available for immediate download
            await checkAvailableDocuments(domain);
        }

        async function checkAvailableDocuments(vendorDomain) {
            try {
                const documentTypes = ['soc2', 'iso27001', 'pci-dss', 'gdpr'];
                const documents = await getComplianceDocuments(vendorDomain, documentTypes);
                
                if (documents && documents.length > 0) {
                    displayAvailableDocuments(documents, vendorDomain);
                } else {
                    hideAvailableDocuments();
                }
            } catch (error) {
                console.error('Error checking available documents:', error);
                hideAvailableDocuments();
            }
        }

        function displayAvailableDocuments(documents, vendorDomain) {
            const container = document.getElementById('tcAvailableDocuments');
            const documentsList = document.getElementById('tcDocumentsList');
            
            const documentElements = documents.map(doc => {
                const docType = doc.document_type.toUpperCase();
                if (doc.content_type === 'webpage' || !doc.is_pdf) {
                    // Render as clickable link for webpages
                    return `
                        <div class="flex items-center justify-between p-2 bg-white rounded border">
                            <span class="text-sm font-medium text-gray-800">
                                <i class="fas fa-external-link-alt mr-2 text-blue-600"></i>${docType}
                            </span>
                            <a href="${doc.source_url}" target="_blank" rel="noopener noreferrer"
                               class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-external-link-alt mr-1"></i>Visit Here
                            </a>
                        </div>
                    `;
                } else {
                    // Render as download button for PDFs
                    return `
                        <div class="flex items-center justify-between p-2 bg-white rounded border">
                            <span class="text-sm font-medium text-gray-800">
                                <i class="fas fa-certificate mr-2 text-green-600"></i>${docType}
                            </span>
                            <button onclick="downloadComplianceDoc('${vendorDomain}', '${doc.document_type}')" 
                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-1"></i>Download
                            </button>
                        </div>
                    `;
                }
            }).join('');

            documentsList.innerHTML = documentElements;
            container.style.display = 'block';
        }

        function hideAvailableDocuments() {
            const container = document.getElementById('tcAvailableDocuments');
            container.style.display = 'none';
        }

        async function downloadTrustCenterDocuments() {
            const domain = document.getElementById('trustVendorDomain').value.trim();
            const selectedDocTypes = Array.from(document.querySelectorAll('input[name="trustDocTypes"]:checked'))
                .map(cb => cb.value.toLowerCase());
            
            if (!domain) {
                alert('Please enter a vendor domain');
                return;
            }
            
            if (selectedDocTypes.length === 0) {
                alert('Please select at least one document type');
                return;
            }
            
            try {
                log(`Downloading compliance documents for ${domain}...`);
                
                // Download each selected document type
                for (const docType of selectedDocTypes) {
                    await downloadComplianceDoc(domain, docType);
                    // Small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log('All document downloads initiated', 'success');
                
            } catch (error) {
                log(`Failed to download documents: ${error.message}`, 'error');
                alert(`Failed to download documents: ${error.message}`);
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                log('Loading dashboard data...');
                const response = await apiCall('/api/v1/dashboard');
                
                if (response.success) {
                    updateDashboardStats(response.data);
                    
                    // Load assessment history to populate vendor select for reporting
                    try {
                        const historyResponse = await apiCall('/api/v1/assessments/history');
                        if (historyResponse.assessments) {
                            populateVendorSelect(historyResponse.assessments);
                        }
                    } catch (error) {
                        console.log('Could not load assessment history for vendor select:', error);
                    }
                } else {
                    throw new Error('Failed to load dashboard data');
                }
                
            } catch (error) {
                log(`Dashboard load failed: ${error.message}`, 'error');
                document.getElementById('dashboardContent').innerHTML = 
                    '<p class="text-red-500 text-center py-8">Failed to load dashboard data</p>';
            }
        }

        function updateDashboardStats(data) {
            // Update basic stats
            document.getElementById('totalAssessments').textContent = data.total_assessments || '0';
            document.getElementById('highRiskVendors').textContent = data.high_risk_vendors || '0';
            document.getElementById('pendingReviews').textContent = data.pending_reviews || '0';
            
            // Calculate and display average risk score
            const avgScore = data.total_assessments > 0 ? 
                Math.round(Object.values(assessment_storage || {})
                    .reduce((sum, assessment) => sum + (assessment.results?.overall_risk_score || 0), 0) / data.total_assessments) : 0;
            document.getElementById('avgRiskScore').textContent = avgScore + '%';
            
            // Update risk distribution chart
            updateRiskDistributionChart(data.risk_distribution);
            
            // Update activity chart (mock data for now)
            updateActivityChart();
            
            // Update main dashboard content
            document.getElementById('dashboardContent').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 border rounded-lg">
                        <h4 class="font-medium mb-3 text-gray-800">
                            <i class="fas fa-clock mr-2 text-blue-600"></i>Recent Assessments
                        </h4>
                        ${generateRecentAssessmentsHtml(data.recent_assessments)}
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h4 class="font-medium mb-3 text-gray-800">
                            <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>Risk Alerts
                        </h4>
                        ${generateRiskAlertsHtml(data)}
                    </div>
                </div>
            `;
        }

        function updateRiskDistributionChart(distribution) {
            const chartContainer = document.getElementById('riskDistributionChart');
            const total = (distribution.low || 0) + (distribution.medium || 0) + (distribution.high || 0);
            
            if (total === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500 text-center">No assessment data available</p>';
                return;
            }
            
            const lowPct = Math.round((distribution.low / total) * 100);
            const mediumPct = Math.round((distribution.medium / total) * 100);
            const highPct = Math.round((distribution.high / total) * 100);
            
            chartContainer.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                            <span class="text-sm font-medium">Low Risk</span>
                        </div>
                        <span class="text-sm text-gray-600">${distribution.low} (${lowPct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${lowPct}%"></div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                            <span class="text-sm font-medium">Medium Risk</span>
                        </div>
                        <span class="text-sm text-gray-600">${distribution.medium} (${mediumPct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: ${mediumPct}%"></div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                            <span class="text-sm font-medium">High Risk</span>
                        </div>
                        <span class="text-sm text-gray-600">${distribution.high} (${highPct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" style="width: ${highPct}%"></div>
                    </div>
                </div>
            `;
        }

        function updateActivityChart() {
            const chartContainer = document.getElementById('activityChart');
            
            // Generate mock activity data for the last 7 days
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const data = [3, 7, 2, 5, 8, 1, 4]; // Mock data
            const maxValue = Math.max(...data);
            
            chartContainer.innerHTML = `
                <div class="flex items-end justify-between h-48 px-4">
                    ${days.map((day, index) => {
                        const height = (data[index] / maxValue) * 100;
                        return `
                            <div class="flex flex-col items-center">
                                <div class="bg-blue-500 rounded-t" style="width: 30px; height: ${height}%; min-height: 4px;"></div>
                                <span class="text-xs text-gray-600 mt-2">${day}</span>
                                <span class="text-xs text-gray-500">${data[index]}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function generateRecentAssessmentsHtml(assessments) {
            if (!assessments || assessments.length === 0) {
                return '<p class="text-sm text-gray-500">No recent assessments</p>';
            }
            
            return assessments.slice(0, 5).map(assessment => {
                const riskLevel = assessment.results?.overall_risk_score >= 70 ? 'high' : 
                                assessment.results?.overall_risk_score >= 40 ? 'medium' : 'low';
                const riskColor = riskLevel === 'high' ? 'text-red-600' : 
                                riskLevel === 'medium' ? 'text-yellow-600' : 'text-green-600';
                
                return `
                    <div class="flex items-center justify-between py-2 border-b last:border-b-0">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <img src="${getVendorLogoUrl(assessment.vendor_domain)}" 
                                     alt="${assessment.vendor_name || assessment.vendor_domain} logo" 
                                     class="w-8 h-8 rounded object-contain bg-white border border-gray-200"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI0IiBmaWxsPSIjRjNGNEY2Ii8+CiAgPGNpcmNsZSBjeD0iMTYiIGN5PSIxNCIgcj0iNCIgZmlsbD0iIzlDQTNBRiIvPgogIDxyZWN0IHg9IjEwIiB5PSIyMCIgd2lkdGg9IjEyIiBoZWlnaHQ9IjIiIHJ4PSIxIiBmaWxsPSIjOUNBM0FGIi8+CiAgPHJlY3QgeD0iOCIgeT0iMjQiIHdpZHRoPSIxNiIgaGVpZ2h0PSIyIiByeD0iMSIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K'; this.onerror=null;">
                            </div>
                            <div>
                                <div class="text-sm font-medium">${assessment.vendor_name || assessment.vendor_domain}</div>
                                <div class="text-xs text-gray-500">${new Date(assessment.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium ${riskColor}">${assessment.results?.overall_risk_score || 0}%</div>
                            <div class="text-xs text-gray-500 capitalize">${riskLevel} risk</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateRiskAlertsHtml(data) {
            const alerts = [];
            
            if (data.high_risk_vendors > 0) {
                alerts.push(`<div class="text-sm text-red-600 mb-2">⚠️ ${data.high_risk_vendors} vendors require immediate attention</div>`);
            }
            
            if (data.pending_reviews > 0) {
                alerts.push(`<div class="text-sm text-yellow-600 mb-2">⏳ ${data.pending_reviews} assessments pending review</div>`);
            }
            
            if (alerts.length === 0) {
                alerts.push('<div class="text-sm text-green-600">✅ No critical alerts</div>');
            }
            
            return alerts.join('');
        }

        // Reporting Functions
        async function loadReportingData() {
            try {
                log('Loading reporting data...');
                
                // Load vendor list for detailed reporting
                const historyResponse = await apiCall('/api/v1/assessments/history');
                if (historyResponse.assessments) {
                    populateVendorSelect(historyResponse.assessments);
                }
                
                log('Reporting data loaded successfully', 'success');
            } catch (error) {
                log(`Failed to load reporting data: ${error.message}`, 'error');
            }
        }

        function populateVendorSelect(assessments) {
            const select = document.getElementById('vendorSelect');
            select.innerHTML = '<option value="all">All Assessed Vendors</option>';
            
            const uniqueVendors = [...new Set(assessments.map(a => a.vendor_domain))];
            uniqueVendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor;
                option.textContent = vendor;
                select.appendChild(option);
            });
        }

        async function generateExecutiveReport() {
            try {
                log('Generating executive summary report...');
                
                const includeDistribution = document.getElementById('includeRiskDistribution').checked;
                const includeTrends = document.getElementById('includeTrendAnalysis').checked;
                const includeRecommendations = document.getElementById('includeRecommendations').checked;
                
                // Get dashboard data for the report
                const dashboardResponse = await apiCall('/api/v1/dashboard');
                if (!dashboardResponse.success) {
                    throw new Error('Failed to get dashboard data');
                }
                
                // Generate the executive report
                const reportContent = generateExecutiveReportContent(dashboardResponse.data, {
                    includeDistribution,
                    includeTrends,
                    includeRecommendations
                });
                
                downloadReportFile(reportContent, 'Executive_Risk_Summary.html');
                log('Executive report generated successfully', 'success');
                
            } catch (error) {
                log(`Failed to generate executive report: ${error.message}`, 'error');
                alert(`Failed to generate executive report: ${error.message}`);
            }
        }

        async function generateDetailedReport() {
            try {
                log('Generating detailed vendor report...');
                
                const selectedVendors = Array.from(document.getElementById('vendorSelect').selectedOptions)
                    .map(option => option.value);
                const includeCompliance = document.getElementById('includeComplianceDetails').checked;
                const includeTechnical = document.getElementById('includeTechnicalFindings').checked;
                
                if (selectedVendors.length === 0) {
                    alert('Please select at least one vendor');
                    return;
                }
                
                // Get assessment history
                const historyResponse = await apiCall('/api/v1/assessments/history');
                if (!historyResponse.assessments) {
                    throw new Error('Failed to get assessment data');
                }
                
                // Filter assessments based on selection
                let assessments = historyResponse.assessments;
                if (!selectedVendors.includes('all')) {
                    assessments = assessments.filter(a => selectedVendors.includes(a.vendor_domain));
                }
                
                // Generate the detailed report
                const reportContent = generateDetailedReportContent(assessments, {
                    includeCompliance,
                    includeTechnical
                });
                
                downloadReportFile(reportContent, 'Detailed_Vendor_Report.html');
                log('Detailed report generated successfully', 'success');
                
            } catch (error) {
                log(`Failed to generate detailed report: ${error.message}`, 'error');
                alert(`Failed to generate detailed report: ${error.message}`);
            }
        }

        async function generateComplianceReport(standard) {
            try {
                log(`Generating ${standard} compliance report...`);
                
                // Get assessment history
                const historyResponse = await apiCall('/api/v1/assessments/history');
                if (!historyResponse.assessments) {
                    throw new Error('Failed to get assessment data');
                }
                
                // Filter assessments that include this compliance standard
                const relevantAssessments = historyResponse.assessments.filter(assessment => 
                    assessment.regulations && assessment.regulations.includes(standard)
                );
                
                if (relevantAssessments.length === 0) {
                    alert(`No assessments found for ${standard} compliance standard`);
                    return;
                }
                
                // Generate compliance-specific report
                const reportContent = generateComplianceReportContent(relevantAssessments, standard);
                
                downloadReportFile(reportContent, `${standard}_Compliance_Report.html`);
                log(`${standard} compliance report generated successfully`, 'success');
                
            } catch (error) {
                log(`Failed to generate ${standard} compliance report: ${error.message}`, 'error');
                alert(`Failed to generate compliance report: ${error.message}`);
            }
        }

        async function exportData(format) {
            try {
                log(`Exporting data in ${format.toUpperCase()} format...`);
                
                // Get assessment history
                const historyResponse = await apiCall('/api/v1/assessments/history');
                if (!historyResponse.assessments) {
                    throw new Error('Failed to get assessment data');
                }
                
                let content, filename, mimeType;
                
                switch (format) {
                    case 'csv':
                        content = generateCSVExport(historyResponse.assessments);
                        filename = 'vendor_assessments.csv';
                        mimeType = 'text/csv';
                        break;
                    case 'json':
                        content = JSON.stringify(historyResponse.assessments, null, 2);
                        filename = 'vendor_assessments.json';
                        mimeType = 'application/json';
                        break;
                    case 'pdf':
                        content = generatePDFExport(historyResponse.assessments);
                        filename = 'vendor_assessments.html';
                        mimeType = 'text/html';
                        break;
                    default:
                        throw new Error('Unsupported export format');
                }
                
                downloadFile(content, filename, mimeType);
                log(`Data exported successfully as ${format.toUpperCase()}`, 'success');
                
            } catch (error) {
                log(`Failed to export data: ${error.message}`, 'error');
                alert(`Failed to export data: ${error.message}`);
            }
        }

        function generateExecutiveReportContent(data, options) {
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Executive Risk Assessment Summary</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .summary-stats { display: flex; justify-content: space-around; margin: 30px 0; }
        .stat-card { text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .risk-high { color: #dc3545; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #28a745; }
        .chart-section { margin: 30px 0; }
        .recommendations { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Executive Risk Assessment Summary</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div class="summary-stats">
        <div class="stat-card">
            <h3>${data.total_assessments}</h3>
            <p>Total Assessments</p>
        </div>
        <div class="stat-card">
            <h3 class="risk-high">${data.high_risk_vendors}</h3>
            <p>High Risk Vendors</p>
        </div>
        <div class="stat-card">
            <h3>${data.pending_reviews}</h3>
            <p>Pending Reviews</p>
        </div>
    </div>
    
    ${options.includeDistribution ? `
    <div class="chart-section">
        <h2>Risk Distribution Analysis</h2>
        <p><span class="risk-low">Low Risk:</span> ${data.risk_distribution.low} vendors</p>
        <p><span class="risk-medium">Medium Risk:</span> ${data.risk_distribution.medium} vendors</p>
        <p><span class="risk-high">High Risk:</span> ${data.risk_distribution.high} vendors</p>
    </div>
    ` : ''}
    
    ${options.includeRecommendations ? `
    <div class="recommendations">
        <h2>Key Recommendations</h2>
        <ul>
            ${data.high_risk_vendors > 0 ? `<li>Prioritize immediate review of ${data.high_risk_vendors} high-risk vendors</li>` : ''}
            <li>Implement continuous monitoring for all vendor relationships</li>
            <li>Establish regular assessment schedules based on risk levels</li>
            <li>Develop vendor risk mitigation strategies</li>
        </ul>
    </div>
    ` : ''}
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
        <p>This report is confidential and intended for internal use only.</p>
    </footer>
</body>
</html>
            `;
        }

        function generateCSVExport(assessments) {
            const headers = ['Vendor Domain', 'Vendor Name', 'Risk Score', 'Status', 'Created Date', 'Regulations'];
            const rows = assessments.map(assessment => [
                assessment.vendor_domain,
                assessment.vendor_name || '',
                assessment.results?.overall_risk_score || '',
                assessment.status || '',
                new Date(assessment.created_at).toLocaleDateString(),
                assessment.regulations?.join(';') || ''
            ]);
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        function downloadReportFile(content, filename) {
            downloadFile(content, filename, 'text/html');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function generateDetailedReportContent(assessments, options) {
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Detailed Vendor Risk Assessment Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .vendor-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .risk-score { font-size: 24px; font-weight: bold; }
        .risk-high { color: #dc3545; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #28a745; }
        .findings { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Detailed Vendor Risk Assessment Report</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>
        <p>Total Vendors: ${assessments.length}</p>
    </div>
    
    ${assessments.map(assessment => {
        const riskScore = assessment.results?.overall_risk_score || 0;
        const riskLevel = riskScore >= 70 ? 'high' : riskScore >= 40 ? 'medium' : 'low';
        const riskClass = `risk-${riskLevel}`;
        
        return `
        <div class="vendor-section">
            <h2>${assessment.vendor_name || assessment.vendor_domain}</h2>
            <p><strong>Domain:</strong> ${assessment.vendor_domain}</p>
            <p><strong>Assessment Date:</strong> ${new Date(assessment.created_at).toLocaleDateString()}</p>
            <p><strong>Risk Score:</strong> <span class="risk-score ${riskClass}">${riskScore}%</span></p>
            <p><strong>Risk Level:</strong> <span class="${riskClass}">${riskLevel.toUpperCase()}</span></p>
            
            ${options.includeCompliance && assessment.regulations ? `
            <h3>Compliance Requirements</h3>
            <p><strong>Regulations:</strong> ${assessment.regulations.join(', ')}</p>
            ` : ''}
            
            ${options.includeTechnical && assessment.results ? `
            <div class="findings">
                <h3>Technical Findings</h3>
                <p><strong>Status:</strong> ${assessment.status}</p>
                ${assessment.results.security_findings ? `
                <p><strong>Security Findings:</strong> ${assessment.results.security_findings}</p>
                ` : ''}
            </div>
            ` : ''}
        </div>
        `;
    }).join('')}
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
        <p>This report is confidential and intended for internal use only.</p>
    </footer>
</body>
</html>
            `;
        }

        function generateComplianceReportContent(assessments, standard) {
            return `
<!DOCTYPE html>
<html>
<head>
    <title>${standard} Compliance Assessment Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .compliance-summary { background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .vendor-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .vendor-table th, .vendor-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .vendor-table th { background-color: #f2f2f2; }
        .compliant { color: #28a745; font-weight: bold; }
        .non-compliant { color: #dc3545; font-weight: bold; }
        .pending { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>${standard} Compliance Assessment Report</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div class="compliance-summary">
        <h2>Compliance Summary</h2>
        <p><strong>Total Vendors Assessed:</strong> ${assessments.length}</p>
        <p><strong>Compliance Standard:</strong> ${standard}</p>
        <p><strong>Assessment Period:</strong> ${new Date(Math.min(...assessments.map(a => new Date(a.created_at)))).toLocaleDateString()} - ${new Date(Math.max(...assessments.map(a => new Date(a.created_at)))).toLocaleDateString()}</p>
    </div>
    
    <h2>Vendor Compliance Status</h2>
    <table class="vendor-table">
        <thead>
            <tr>
                <th>Vendor</th>
                <th>Domain</th>
                <th>Risk Score</th>
                <th>Compliance Status</th>
                <th>Assessment Date</th>
            </tr>
        </thead>
        <tbody>
            ${assessments.map(assessment => {
                const riskScore = assessment.results?.overall_risk_score || 0;
                const complianceStatus = riskScore < 40 ? 'Compliant' : riskScore < 70 ? 'Partially Compliant' : 'Non-Compliant';
                const statusClass = riskScore < 40 ? 'compliant' : riskScore < 70 ? 'pending' : 'non-compliant';
                
                return `
                <tr>
                    <td>
                        <div class="flex items-center space-x-2">
                            <img src="${getVendorLogoUrl(assessment.vendor_domain)}" 
                                 alt="${assessment.vendor_name || assessment.vendor_domain} logo" 
                                 class="w-6 h-6 rounded object-contain bg-white border border-gray-200"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSIzIiBmaWxsPSIjRjNGNEY2Ii8+CiAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMCIgcj0iMyIgZmlsbD0iIzlDQTNBRiIvPgogIDxyZWN0IHg9IjgiIHk9IjE1IiB3aWR0aD0iOCIgaGVpZ2h0PSIxLjUiIHJ4PSIwLjc1IiBmaWxsPSIjOUNBM0FGIi8+CiAgPHJlY3QgeD0iNiIgeT0iMTgiIHdpZHRoPSIxMiIgaGVpZ2h0PSIxLjUiIHJ4PSIwLjc1IiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='; this.onerror=null;">
                            <span>${assessment.vendor_name || assessment.vendor_domain}</span>
                        </div>
                    </td>
                    <td>${assessment.vendor_domain}</td>
                    <td>${riskScore}%</td>
                    <td class="${statusClass}">${complianceStatus}</td>
                    <td>${new Date(assessment.created_at).toLocaleDateString()}</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
        <p>This report is confidential and intended for internal use only.</p>
    </footer>
</body>
</html>
            `;
        }

        function generatePDFExport(assessments) {
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Vendor Assessment Data Export</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .export-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 12px; }
        .export-table th, .export-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .export-table th { background-color: #f2f2f2; }
        .risk-high { background-color: #ffebee; }
        .risk-medium { background-color: #fff8e1; }
        .risk-low { background-color: #e8f5e8; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vendor Assessment Data Export</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>
        <p>Total Records: ${assessments.length}</p>
    </div>
    
    <table class="export-table">
        <thead>
            <tr>
                <th>Vendor Domain</th>
                <th>Vendor Name</th>
                <th>Risk Score</th>
                <th>Risk Level</th>
                <th>Status</th>
                <th>Regulations</th>
                <th>Created Date</th>
                <th>Business Criticality</th>
                <th>Data Sensitivity</th>
            </tr>
        </thead>
        <tbody>
            ${assessments.map(assessment => {
                const riskScore = assessment.results?.overall_risk_score || 0;
                const riskLevel = riskScore >= 70 ? 'High' : riskScore >= 40 ? 'Medium' : 'Low';
                const riskClass = riskLevel.toLowerCase();
                
                return `
                <tr class="risk-${riskClass}">
                    <td>${assessment.vendor_domain}</td>
                    <td>${assessment.vendor_name || '-'}</td>
                    <td>${riskScore}%</td>
                    <td>${riskLevel}</td>
                    <td>${assessment.status || 'Unknown'}</td>
                    <td>${assessment.regulations?.join(', ') || '-'}</td>
                    <td>${new Date(assessment.created_at).toLocaleDateString()}</td>
                    <td>${assessment.business_criticality || '-'}</td>
                    <td>${assessment.data_sensitivity || '-'}</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
        <p>This export contains confidential vendor assessment data.</p>
    </footer>
</body>
</html>
            `;
        }

        // History Functions
        async function loadAssessmentHistory() {
            try {
                log('Loading assessment history...');
                const response = await apiCall('/api/v1/assessments/history');
                
                if (response.assessments) {
                    displayAssessmentHistory(response.assessments);
                } else {
                    throw new Error('No history data received');
                }
                
            } catch (error) {
                log(`History load failed: ${error.message}`, 'error');
                document.getElementById('assessmentHistory').innerHTML = 
                    '<p class="text-red-500 text-center py-8">Failed to load assessment history</p>';
            }
        }

        function displayAssessmentHistory(assessments) {
            const historyContainer = document.getElementById('assessmentHistory');
            
            if (assessments.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No assessments found</p>';
                return;
            }
            
            historyContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overall Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compliance Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Security Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Protection Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Breaches</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Features</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${assessments.map(assessment => {
                                const results = assessment.results || {};
                                const letterGrades = results.letter_grades || {};
                                const scores = results.scores || {};
                                const breaches = results.data_breaches || {};
                                const aiFeatures = results.ai_features || {};
                                
                                return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">${assessment.vendor_name || 'Unknown'}</div>
                                            <div class="text-sm text-gray-500">${assessment.vendor_domain}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            ${letterGrades.overall ? `
                                                <div class="text-lg font-bold ${getLetterGradeColorClass(letterGrades.overall)}">${letterGrades.overall}</div>
                                                <div class="text-xs text-gray-500">${assessment.risk_score || results.overall_score || 0}/100</div>
                                            ` : `
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRiskColorClass(assessment.risk_score)}">
                                                    ${assessment.risk_score || 'N/A'}%
                                                </span>
                                            `}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            <div class="text-lg font-bold ${getLetterGradeColorClass(letterGrades.compliance || 'N/A')}">${letterGrades.compliance || 'N/A'}</div>
                                            <div class="text-xs text-gray-500">${scores.compliance || 0}/100</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            <div class="text-lg font-bold ${getLetterGradeColorClass(letterGrades.security || 'N/A')}">${letterGrades.security || 'N/A'}</div>
                                            <div class="text-xs text-gray-500">${scores.security || 0}/100</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            <div class="text-lg font-bold ${getLetterGradeColorClass(letterGrades.data_protection || 'N/A')}">${letterGrades.data_protection || 'N/A'}</div>
                                            <div class="text-xs text-gray-500">${scores.data_protection || 0}/100</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            <div class="text-sm font-medium ${breaches.total_breaches > 0 ? 'text-red-600' : 'text-green-600'}">
                                                ${breaches.total_breaches || 0}
                                            </div>
                                            <div class="text-xs text-gray-500">${formatStatus(breaches.severity || 'None')}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-center">
                                            <div class="text-sm font-medium">${formatStatus(aiFeatures.maturity_level || 'Unknown')}</div>
                                            <div class="text-xs text-gray-500">${formatStatus(aiFeatures.risk_level || 'N/A')}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColorClass(assessment.status)}">
                                            ${formatStatus(assessment.status)}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${new Date(assessment.created_at).toLocaleDateString()}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="viewAssessment('${assessment.id}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                                        <button onclick="downloadReport('${assessment.id}')" class="text-green-600 hover:text-green-900">Download</button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getStatusColorClass(status) {
            switch (status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'processing': return 'bg-blue-100 text-blue-800';
                case 'failed': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function refreshHistory() {
            loadAssessmentHistory();
        }

        async function viewAssessment(assessmentId) {
            try {
                log(`Loading assessment details for ${assessmentId}...`);
                const result = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                
                if (result.success && result.assessment) {
                    showAssessmentModal(result.assessment);
                } else {
                    log('Failed to load assessment details', 'error');
                    alert('Failed to load assessment details. Please try again.');
                }
            } catch (error) {
                console.error('Error viewing assessment:', error);
                log(`Failed to load assessment: ${error.message}`, 'error');
                alert('Failed to load assessment details. Please try again.');
            }
        }

        function showAssessmentModal(assessment) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'assessmentModal';
            
            const overallScore = assessment.risk_score || 0;
            const hasLetterGrades = assessment.letter_grades && Object.keys(assessment.letter_grades).length > 0;
            const riskFactors = assessment.detailed_analysis?.risk_factors || [];
            const recommendations = assessment.recommendations || [];
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Assessment Details - ${assessment.vendor_name}</h3>
                        <button onclick="closeAssessmentModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold">Vendor Information</h4>
                                <div class="text-right">
                                    ${hasLetterGrades && assessment.letter_grades.overall ? `
                                        <div class="inline-flex items-center px-3 py-1 rounded-full text-lg font-bold ${getLetterGradeColorClass(assessment.letter_grades.overall)}">
                                            ${assessment.letter_grades.overall}
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">${overallScore}/100</div>
                                    ` : `
                                        <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRiskColorClass(overallScore)}">
                                            ${overallScore}% Risk Score
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p><strong>Domain:</strong> ${assessment.vendor_domain}</p>
                                <p><strong>Status:</strong> ${assessment.status}</p>
                                <p><strong>Created:</strong> ${new Date(assessment.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        ${hasLetterGrades ? `
                            <div class="mb-4">
                                <h4 class="text-md font-semibold mb-2">Security Grades</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="p-3 bg-white border rounded text-center">
                                        <h5 class="font-medium text-gray-700 mb-1">Compliance</h5>
                                        <div class="text-xl font-bold ${getLetterGradeColorClass(assessment.letter_grades.compliance)}">
                                            ${assessment.letter_grades.compliance || 'N/A'}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${assessment.scores?.compliance || 0}/100</div>
                                    </div>
                                    <div class="p-3 bg-white border rounded text-center">
                                        <h5 class="font-medium text-gray-700 mb-1">Security</h5>
                                        <div class="text-xl font-bold ${getLetterGradeColorClass(assessment.letter_grades.security)}">
                                            ${assessment.letter_grades.security || 'N/A'}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${assessment.scores?.security || 0}/100</div>
                                    </div>
                                    <div class="p-3 bg-white border rounded text-center">
                                        <h5 class="font-medium text-gray-700 mb-1">Data Protection</h5>
                                        <div class="text-xl font-bold ${getLetterGradeColorClass(assessment.letter_grades.data_protection)}">
                                            ${assessment.letter_grades.data_protection || 'N/A'}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">${assessment.scores?.data_protection || 0}/100</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${riskFactors.length > 0 ? `
                            <div class="mb-4">
                                <h4 class="text-md font-semibold mb-2">Risk Factors</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${riskFactors.map(factor => `
                                        <div class="p-3 border rounded">
                                            <h5 class="font-medium text-sm text-gray-800">${factor.category || 'Unknown'}</h5>
                                            <p class="text-xs text-gray-600 mt-1">${factor.description || factor.item || 'No description'}</p>
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium mt-2 ${factor.status === 'compliant' ? 'bg-green-100 text-green-800' : factor.status === 'needs_review' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                                ${formatStatus(factor.status)}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${recommendations.length > 0 ? `
                            <div class="mb-4">
                                <h4 class="text-md font-semibold mb-2">Recommendations</h4>
                                <div class="bg-blue-50 p-3 rounded">
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        ${recommendations.map(rec => `<li>• ${typeof rec === 'string' ? rec : rec.action || rec.description || 'Unknown recommendation'}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="downloadReport('${assessment.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Download Report
                        </button>
                        <button onclick="closeAssessmentModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeAssessmentModal() {
            const modal = document.getElementById('assessmentModal');
            if (modal) {
                modal.remove();
            }
        }

        async function downloadReport(assessmentId) {
            try {
                log(`Starting enhanced PDF download for assessment ${assessmentId}...`);
                console.log(`Enhanced PDF download triggered for assessment ID: ${assessmentId}`);
                
                // Get assessment data from server
                const result = await apiCall(`/api/v1/assessments/${assessmentId}`, 'GET');
                
                if (!result.success || !result.assessment) {
                    throw new Error('Failed to retrieve assessment data');
                }
                
                const assessment = result.assessment;
                const results = assessment.results || {};
                const resultData = results.results || results;
                
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up fonts and styling
                doc.setFont('helvetica');
                
                // HEADER PAGE
                // Main title
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('VENDOR RISK ASSESSMENT REPORT', 20, 30);
                
                // Vendor information section
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`VENDOR: ${resultData.vendor_name || assessment.vendor_name || 'Unknown Vendor'}`, 20, 55);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(102, 102, 102);
                doc.text(`Domain: ${resultData.vendor_domain || assessment.vendor_domain || 'Unknown Domain'}`, 20, 70);
                doc.text(`Assessment Date: ${new Date(assessment.created_at).toLocaleDateString()}`, 20, 80);
                doc.text(`Assessment ID: ${assessmentId}`, 20, 90);
                
                // Assessment Mode - NEW ADDITION
                const assessmentMode = assessment.assessment_mode || resultData.assessment_mode || 'Standard Assessment';
                const assessmentType = resultData.assessment_type || 'standard';
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text(`Assessment Mode: ${assessmentMode.replace('_', ' ').toUpperCase()}`, 20, 105);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(102, 102, 102);
                if (assessmentMode === 'technical_due_diligence') {
                    doc.text('Technical Due Diligence - Deep technical security assessment', 20, 115);
                } else if (assessmentMode === 'business_risk') {
                    doc.text('Business Risk Assessment - Business-focused risk evaluation', 20, 115);
                } else {
                    doc.text('Standard vendor risk assessment evaluation', 20, 115);
                }
                
                // Overall Assessment Results
                const hasLetterGrades = resultData.letter_grades || false;
                const overallScore = assessment.risk_score || resultData.overall_score || resultData.overall_risk_score || 0;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('OVERALL ASSESSMENT RESULTS', 20, 140);
                
                if (hasLetterGrades) {
                    // Letter grade display
                    const overallGrade = resultData.letter_grades.overall || 'N/A';
                    doc.setFontSize(24);
                    doc.text(`Overall Grade: ${overallGrade}`, 20, 160);
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Risk Score: ${overallScore}/100`, 20, 175);
                    
                    if (resultData.risk_description) {
                        doc.setFontSize(12);
                        doc.text(`Risk Level: ${resultData.risk_description}`, 20, 185);
                    }
                    if (resultData.business_recommendation) {
                        doc.setFontSize(11);
                        doc.text(`Business Recommendation: ${resultData.business_recommendation}`, 20, 195);
                    }
                } else {
                    // Percentage score display
                    let riskLevel = 'Unknown';
                    if (overallScore <= 30) {
                        riskLevel = 'LOW RISK';
                    } else if (overallScore <= 60) {
                        riskLevel = 'MEDIUM RISK';
                    } else {
                        riskLevel = 'HIGH RISK';
                    }
                    
                    doc.setFontSize(24);
                    doc.text(`Risk Score: ${overallScore}%`, 20, 160);
                    doc.setFontSize(16);
                    doc.text(`Risk Level: ${riskLevel}`, 20, 175);
                }
                
                let yPosition = 210;
                
                // Assessment Frameworks Used
                if (resultData.frameworks_used && resultData.frameworks_used.length > 0) {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('ASSESSMENT FRAMEWORKS USED', 20, yPosition);
                    yPosition += 15;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    resultData.frameworks_used.forEach(framework => {
                        doc.text(`- ${framework}`, 25, yPosition);
                        yPosition += 10;
                    });
                    yPosition += 10;
                }
                
                // Detailed Security Assessment Breakdown
                if (hasLetterGrades && resultData.letter_grades) {
                    if (yPosition > 220) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('SECURITY ASSESSMENT BREAKDOWN', 20, yPosition);
                    yPosition += 20;
                    
                    const scores = resultData.scores || {};
                    const assessmentAreas = [
                        { name: 'Compliance', grade: resultData.letter_grades.compliance, score: scores.compliance },
                        { name: 'Security', grade: resultData.letter_grades.security, score: scores.security },
                        { name: 'Data Protection', grade: resultData.letter_grades.data_protection, score: scores.data_protection }
                    ];
                    
                    assessmentAreas.forEach(area => {
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${area.name}:`, 25, yPosition);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Grade: ${area.grade || 'N/A'}`, 80, yPosition);
                        doc.text(`Score: ${area.score || 0}/100`, 130, yPosition);
                        yPosition += 12;
                    });
                    yPosition += 15;
                }
                
                // Pillar Scores (if available)
                if (resultData.pillar_scores) {
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('ASSESSMENT PILLAR SCORES', 20, yPosition);
                    yPosition += 20;
                    
                    Object.entries(resultData.pillar_scores).forEach(([pillar, score]) => {
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${pillar.charAt(0).toUpperCase() + pillar.slice(1)}:`, 25, yPosition);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${Math.round(score)}/100`, 100, yPosition);
                        yPosition += 12;
                    });
                    yPosition += 15;
                }
                
                // Risk Assessment Details
                const riskFactors = resultData.risk_factors || resultData.findings || [];
                if (riskFactors.length > 0) {
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('DETAILED RISK ASSESSMENT', 20, yPosition);
                    yPosition += 20;
                    
                    riskFactors.forEach((factor, index) => {
                        if (yPosition > 250) {
                            doc.addPage();
                            yPosition = 30;
                        }
                        
                        const category = factor.category || 'Unknown Category';
                        const description = factor.description || factor.item || 'No description';
                        const status = formatStatus(factor.status || 'Unknown');
                        
                        // Category header
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(55, 65, 81);
                        doc.text(`${index + 1}. ${category}`, 25, yPosition);
                        yPosition += 10;
                        
                        // Description
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(102, 102, 102);
                        
                        // Handle long descriptions with word wrapping
                        const lines = doc.splitTextToSize(description, 160);
                        lines.forEach(line => {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 30;
                            }
                            doc.text(line, 30, yPosition);
                            yPosition += 8;
                        });
                        
                        // Status
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Status: ${status}`, 30, yPosition);
                        yPosition += 15;
                    });
                }
                
                // Data Breach History Section
                if (resultData.data_breaches) {
                    if (yPosition > 180) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('DATA BREACH HISTORY', 20, yPosition);
                    yPosition += 20;
                    
                    const breaches = resultData.data_breaches;
                    const breachesFound = breaches.breaches_found || 0;
                    const trackRecord = breaches.security_track_record || 'Unknown';
                    const breachDetails = breaches.breach_details || [];
                    
                    // Summary information
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total Security Breaches Found: ${breachesFound}`, 25, yPosition);
                    yPosition += 10;
                    doc.text(`Security Track Record: ${trackRecord}`, 25, yPosition);
                    yPosition += 10;
                    
                    const recentBreaches = breachDetails.filter(breach => (breach.years_ago || 999) <= 3);
                    doc.text(`Recent Breaches (Last 3 Years): ${recentBreaches.length}`, 25, yPosition);
                    yPosition += 15;
                    
                    // Detailed breach information
                    if (breachesFound > 0 && breachDetails.length > 0) {
                        doc.setFont('helvetica', 'bold');
                        doc.text('Security Incident Details:', 25, yPosition);
                        yPosition += 12;
                        
                        doc.setFont('helvetica', 'normal');
                        breachDetails.slice(0, 5).forEach((breach, index) => {
                            if (yPosition > 250) {
                                doc.addPage();
                                yPosition = 30;
                            }
                            
                            doc.text(`${index + 1}. Date: ${breach.incident_date || 'Unknown'}`, 30, yPosition);
                            yPosition += 8;
                            doc.text(`   Type: ${breach.breach_type || 'Security Incident'}`, 30, yPosition);
                            yPosition += 8;
                            doc.text(`   Severity: ${formatStatus(breach.severity || 'Unknown')}`, 30, yPosition);
                            yPosition += 8;
                            doc.text(`   Affected Records: ${breach.affected_records || 'Unknown'}`, 30, yPosition);
                            yPosition += 12;
                        });
                    } else {
                        doc.setFont('helvetica', 'normal');
                        doc.text('No major security breaches found in public databases.', 25, yPosition);
                        yPosition += 8;
                        doc.text('This vendor has maintained a clean security record.', 25, yPosition);
                        yPosition += 15;
                    }
                }
                
                // AI Features Section
                if (resultData.ai_features) {
                    if (yPosition > 180) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('AI FEATURES AND SERVICES', 20, yPosition);
                    yPosition += 20;
                    
                    const ai = resultData.ai_features;
                    const offersAI = ai.offers_ai_services || false;
                    
                    if (offersAI) {
                        const maturityLevel = formatStatus(ai.ai_maturity_level || ai.maturity_level || 'Unknown');
                        const serviceCategories = ai.ai_service_categories || [];
                        const governance = ai.ai_governance || {};
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`AI Services Offered: Yes`, 25, yPosition);
                        yPosition += 10;
                        doc.text(`AI Maturity Level: ${maturityLevel}`, 25, yPosition);
                        yPosition += 10;
                        doc.text(`Service Categories: ${serviceCategories.length}`, 25, yPosition);
                        yPosition += 10;
                        
                        if (governance.governance_score) {
                            doc.text(`AI Governance Score: ${governance.governance_score}/100`, 25, yPosition);
                            yPosition += 10;
                        }
                        
                        // List service categories
                        if (serviceCategories.length > 0) {
                            yPosition += 5;
                            doc.setFont('helvetica', 'bold');
                            doc.text('AI Service Categories:', 25, yPosition);
                            yPosition += 10;
                            
                            doc.setFont('helvetica', 'normal');
                            serviceCategories.forEach(category => {
                                if (yPosition > 270) {
                                    doc.addPage();
                                    yPosition = 30;
                                }
                                doc.text(`- ${category}`, 30, yPosition);
                                yPosition += 8;
                            });
                        }
                    } else {
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text('AI Services Offered: No', 25, yPosition);
                        yPosition += 8;
                        doc.text('This vendor does not appear to offer AI-powered features or services.', 25, yPosition);
                    }
                    yPosition += 15;
                }
                
                // Trust Center Information
                if (resultData.trust_center_access) {
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('TRUST CENTER ACCESS', 20, yPosition);
                    yPosition += 20;
                    
                    const trustCenter = resultData.trust_center_access;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    
                    doc.text(`Access Method: ${trustCenter.access_method || 'Unknown'}`, 25, yPosition);
                    yPosition += 10;
                    doc.text(`Status: ${trustCenter.message || 'Processed'}`, 25, yPosition);
                    yPosition += 10;
                    
                    if (trustCenter.documents && trustCenter.documents.length > 0) {
                        doc.text(`Documents Available: ${trustCenter.documents.length}`, 25, yPosition);
                        yPosition += 15;
                    }
                    
                    if (trustCenter.trust_center_url) {
                        doc.text(`Trust Center URL: ${trustCenter.trust_center_url}`, 25, yPosition);
                        yPosition += 15;
                    }
                }
                
                // Recommendations Section
                const recommendations = resultData.recommendations || [];
                if (recommendations.length > 0) {
                    if (yPosition > 150) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('RECOMMENDATIONS', 20, yPosition);
                    yPosition += 20;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    
                    recommendations.forEach((rec, index) => {
                        if (yPosition > 260) {
                            doc.addPage();
                            yPosition = 30;
                        }
                        
                        const recommendation = typeof rec === 'string' ? rec : rec.action || rec.description || 'No recommendation details';
                        
                        // Handle long recommendations with word wrapping
                        const lines = doc.splitTextToSize(`${index + 1}. ${recommendation}`, 160);
                        lines.forEach(line => {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 30;
                            }
                            doc.text(line, 25, yPosition);
                            yPosition += 8;
                        });
                        yPosition += 5;
                    });
                }
                
                // Footer with generation info on all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Generated by Vendor Risk Assessment System - ${new Date().toLocaleDateString()}`, 20, 285);
                    doc.text(`Assessment ID: ${assessmentId}`, 20, 290);
                    doc.text(`Page ${i} of ${pageCount}`, 170, 285);
                    doc.text(`Assessment Mode: ${assessmentMode.replace('_', ' ')}`, 170, 290);
                }
                
                // Save the PDF with improved filename
                const vendorName = (assessment.vendor_name || 'vendor').replace(/[^a-zA-Z0-9]/g, '_');
                const assessmentModeShort = assessmentMode.replace('_', '-');
                const fileName = `${vendorName}_${assessmentModeShort}_assessment_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                log(`Enhanced PDF download completed successfully: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Error generating enhanced PDF report:', error);
                log(`Failed to generate enhanced PDF report: ${error.message}`, 'error');
                alert(`Failed to generate enhanced PDF report: ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        function generateReportContent(assessment) {
            const overallScore = assessment.risk_score || 0;
            const riskFactors = assessment.detailed_analysis?.risk_factors || [];
            const recommendations = assessment.recommendations || [];
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Vendor Risk Assessment Report - ${assessment.vendor_name}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .score { font-size: 24px; font-weight: bold; color: ${overallScore <= 30 ? '#22c55e' : overallScore <= 60 ? '#f59e0b' : '#ef4444'}; }
        .section { margin-bottom: 30px; }
        .risk-factor { background: #f9fafb; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #e5e7eb; }
        .recommendation { background: #eff6ff; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
        .grade { display: inline-block; padding: 5px 10px; border-radius: 20px; font-weight: bold; }
        .grade-a { background: #dcfce7; color: #166534; }
        .grade-b { background: #fef3c7; color: #92400e; }
        .grade-c { background: #fed7aa; color: #9a3412; }
        .grade-d { background: #fecaca; color: #991b1b; }
        .grade-f { background: #fee2e2; color: #7f1d1d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vendor Risk Assessment Report</h1>
        <h2>${assessment.vendor_name}</h2>
        <p><strong>Domain:</strong> ${assessment.vendor_domain}</p>
        <p><strong>Assessment Date:</strong> ${new Date(assessment.created_at).toLocaleDateString()}</p>
        <p><strong>Status:</strong> ${assessment.status}</p>
        <div class="score">Overall Risk Score: ${overallScore}%</div>
    </div>
    
    ${assessment.letter_grades ? `
        <div class="section">
            <h3>Security Grades</h3>
            <p>Compliance: <span class="grade grade-${assessment.letter_grades.compliance?.toLowerCase() || 'n'}">${assessment.letter_grades.compliance || 'N/A'}</span></p>
            <p>Security: <span class="grade grade-${assessment.letter_grades.security?.toLowerCase() || 'n'}">${assessment.letter_grades.security || 'N/A'}</span></p>
            <p>Data Protection: <span class="grade grade-${assessment.letter_grades.data_protection?.toLowerCase() || 'n'}">${assessment.letter_grades.data_protection || 'N/A'}</span></p>
        </div>
    ` : ''}
    
    ${riskFactors.length > 0 ? `
        <div class="section">
            <h3>Risk Factors</h3>
            ${riskFactors.map(factor => `
                <div class="risk-factor">
                    <h4>${factor.category || 'Unknown Category'}</h4>
                    <p>${factor.description || factor.item || 'No description available'}</p>
                    <p><strong>Status:</strong> ${factor.status || 'Unknown'}</p>
                </div>
            `).join('')}
        </div>
    ` : ''}
    
    ${recommendations.length > 0 ? `
        <div class="section">
            <h3>Recommendations</h3>
            ${recommendations.map(rec => `
                <div class="recommendation">
                    <p>${typeof rec === 'string' ? rec : rec.action || rec.description || 'Unknown recommendation'}</p>
                </div>
            `).join('')}
        </div>
    ` : ''}
    
    <div class="section">
        <h3>Assessment Summary</h3>
        <p>This automated risk assessment was generated on ${new Date().toLocaleDateString()} for ${assessment.vendor_name}. 
        The assessment analyzed various security and compliance factors to determine the overall risk score of ${overallScore}%.</p>
        <p><em>This report is for informational purposes and should be reviewed by qualified security personnel.</em></p>
    </div>
</body>
</html>
            `.trim();
        }

        // Debug function to test download capability
        function testDownload() {
            console.log('Testing download capability...');
            const testContent = '<!DOCTYPE html><html><head><title>Test Report</title></head><body><h1>Test Download</h1><p>This is a test download to verify functionality.</p></body></html>';
            
            try {
                const blob = new Blob([testContent], { type: 'text/html;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'test_download.html';
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    console.log('Test download completed');
                }, 1000);
                
                log('Test download initiated', 'info');
            } catch (error) {
                console.error('Test download failed:', error);
                alert('Download test failed: ' + error.message);
            }
        }

        async function downloadDocument(downloadUrl) {
            try {
                log(`Downloading document from ${downloadUrl}`);
                
                // Create a temporary anchor element to trigger download
                const fullUrl = apiConfig.getApiUrl(downloadUrl);
                
                // Use fetch to get the file with proper headers
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/pdf',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Get the filename from headers or create one
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'trust_center_document.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
                
                // Get the blob and create download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                log(`Document downloaded successfully: ${filename}`);
                
            } catch (error) {
                log(`Failed to download document: ${error.message}`, 'error');
                alert(`Download failed: ${error.message}`);
            }
        }

        // Simple notification system
        function showNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
            
            // Set colors based on type
            let bgColor = 'bg-blue-500';
            let textColor = 'text-white';
            let icon = 'fas fa-info-circle';
            
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'fas fa-exclamation-triangle';
                    break;
            }
            
            notification.className += ` ${bgColor} ${textColor}`;
            
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="${icon} mt-0.5"></i>
                    <div class="flex-1">
                        <h4 class="font-medium">${title}</h4>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="opacity-70 hover:opacity-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(full)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Function to download the current assessment report
        function downloadCurrentReport() {
            if (!currentAssessmentId) {
                showNotification('Error', 'No current assessment found to download.', 'error');
                return;
            }
            
            downloadReport(currentAssessmentId);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            log('Combined UI interface initialized', 'success');
            showTab('single');
        });
    </script>
</body>
</html>

